<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>czip.cz &mdash; czip 0.1 documentation</title>
    <link href="../../_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="../../_static/css/theme.css" rel="stylesheet" type="text/css"/>
    <link href="../../_static/css/rtd_sphinx_search.min.css" rel="stylesheet" type="text/css"/>
    <link href="../../_static/css/custom.css" rel="stylesheet" type="text/css"/>
    <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
    <![endif]-->

    <script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script data-url_root="../../" id="documentation_options"
            src="../../_static/documentation_options.js?v=e031e9a9"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../_static/js/rtd_search_config.js"></script>
    <script src="../../_static/js/rtd_sphinx_search.min.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA="
            src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link href="../../genindex.html" rel="index" title="Index"/>
    <link href="../../search.html" rel="search" title="Search"/>
</head>

<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
    <nav class="wy-nav-side" data-toggle="wy-nav-shift">
        <div class="wy-side-scroll">
            <div class="wy-side-nav-search">


                <a class="icon icon-home" href="../../index.html">
                    czip
                </a>
                <div role="search">
                    <form action="../../search.html" class="wy-form" id="rtd-search-form" method="get">
                        <input aria-label="Search docs" name="q" placeholder="Search docs" type="text"/>
                        <input name="check_keywords" type="hidden" value="yes"/>
                        <input name="area" type="hidden" value="default"/>
                    </form>
                </div>
            </div>
            <div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Quick Started</a>
                        <ul>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/quick_start.html">1. Installation</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/quick_start.html#2.-Writer">2. Writer</a>
                            </li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/quick_start.html#3.-Reader">3. Reader</a>
                            </li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/quick_start.html#4.-Query">4. Query</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/quick_start.html#5.-Subset">5. Subset</a>
                            </li>
                        </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../dnam.html">DNA methylation data</a>
                        <ul>
                            <li class="toctree-l2"><a class="reference internal" href="../../notebooks/dnam.html">Generate
                                allc coordinate reference .cz file</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#View-reference-.cz-file">View
                                reference .cz file</a>
                                <ul>
                                    <li class="toctree-l3"><a class="reference internal"
                                                              href="../../notebooks/dnam.html#view-header">view
                                        header</a></li>
                                    <li class="toctree-l3"><a class="reference internal"
                                                              href="../../notebooks/dnam.html#summary-chunks">summary
                                        chunks</a></li>
                                </ul>
                            </li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#Converting-.allc.tsv.gz-into-.cz-file">Converting
                                .allc.tsv.gz into .cz file</a>
                                <ul>
                                    <li class="toctree-l3"><a class="reference internal"
                                                              href="../../notebooks/dnam.html#Pack-.allc.tsv.gz-to-.cz-with-coordinates">Pack
                                        .allc.tsv.gz to .cz with coordinates</a></li>
                                    <li class="toctree-l3"><a class="reference internal"
                                                              href="../../notebooks/dnam.html#Pack-.allc.tsv.gz-to-.cz-without-coordinates-(using-reference)">Pack
                                        .allc.tsv.gz to .cz without coordinates (using reference)</a></li>
                                    <li class="toctree-l3"><a class="reference internal"
                                                              href="../../notebooks/dnam.html#Query">Query</a>
                                        <ul>
                                            <li class="toctree-l4"><a class="reference internal"
                                                                      href="../../notebooks/dnam.html#query-allc.tsv.gz-using-tabix">query
                                                allc.tsv.gz using tabix</a></li>
                                            <li class="toctree-l4"><a class="reference internal"
                                                                      href="../../notebooks/dnam.html#query-allc.cz-using-czip">query
                                                allc.cz using czip</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#Cat-multiple-.cz-files-into-one-.cz-file">Cat
                                multiple .cz files into one .cz file</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#Extract-CG-from-.cz-and-merge-strand">Extract
                                CG from .cz and merge strand</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#Merge-multiple-.cz-files-into-one-.cz-file">Merge
                                multiple .cz files into one .cz file</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#Merge-.cz-files-belonging-to-the-same-cell-type">Merge
                                .cz files belonging to the same cell type</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#Run-czip-allc2cz-on-GCP">Run czip
                                allc2cz on GCP</a></li>
                            <li class="toctree-l2"><a class="reference internal"
                                                      href="../../notebooks/dnam.html#Run-czip-extractCG-on-GCP">Run
                                czip extractCG on GCP</a></li>
                        </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../benchmark.html">Benchmark</a>
                        <ul>
                            <li class="toctree-l2"><a class="reference internal" href="../../benchmark.html#storage">1.Storage</a>
                            </li>
                        </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules.html">czip</a>
                        <ul>
                            <li class="toctree-l2"><a class="reference internal" href="../../czip.html">czip package</a>
                                <ul>
                                    <li class="toctree-l3"><a class="reference internal"
                                                              href="../../czip.html#submodules">Submodules</a>
                                        <ul>
                                            <li class="toctree-l4"><a class="reference internal"
                                                                      href="../../czip.allc.html">czip.allc module</a>
                                                <ul>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.AllC"><code
                                                            class="docutils literal notranslate"><span
                                                            class="pre">AllC</span></code></a>
                                                        <ul>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.allc.html#czip.allc.AllC.merge"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">AllC.merge()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.allc.html#czip.allc.AllC.run"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">AllC.run()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.allc.html#czip.allc.AllC.writePattern"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">AllC.writePattern()</span></code></a>
                                                            </li>
                                                        </ul>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.WriteC"><code
                                                            class="docutils literal notranslate"><span class="pre">WriteC()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.bed2cz"><code
                                                            class="docutils literal notranslate"><span class="pre">bed2cz()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.extractCG"><code
                                                            class="docutils literal notranslate"><span class="pre">extractCG()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.generate_ssi"><code
                                                            class="docutils literal notranslate"><span class="pre">generate_ssi()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.merge_cell_type"><code
                                                            class="docutils literal notranslate"><span class="pre">merge_cell_type()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.merge_cz"><code
                                                            class="docutils literal notranslate"><span class="pre">merge_cz()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.allc.html#czip.allc.merge_cz_worker"><code
                                                            class="docutils literal notranslate"><span class="pre">merge_cz_worker()</span></code></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="toctree-l4"><a class="reference internal"
                                                                      href="../../czip.cz.html">czip.cz module</a>
                                                <ul>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.Reader"><code
                                                            class="docutils literal notranslate"><span class="pre">Reader</span></code></a>
                                                        <ul>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.batch_fetch"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.batch_fetch()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.category_ssi"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.category_ssi()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.chunk2df"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.chunk2df()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.close"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.close()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.fetch"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.fetch()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.fetchByStartID"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.fetchByStartID()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.fileno"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.fileno()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.getRecordsByIdRegions"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.getRecordsByIdRegions()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.getRecordsByIds"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.getRecordsByIds()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.get_chunks"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.get_chunks()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.get_ids_from_ssi"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.get_ids_from_ssi()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.isatty"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.isatty()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.pos2id"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.pos2id()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.print_header"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.print_header()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.query"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.query()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.read"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.read()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.read_header"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.read_header()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.readline"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.readline()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.seek"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.seek()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.seekable"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.seekable()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.subset"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.subset()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.summary_blocks"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.summary_blocks()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.summary_chunks"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.summary_chunks()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.tell"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.tell()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Reader.view"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Reader.view()</span></code></a></li>
                                                        </ul>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.SummaryBczBlocks"><code
                                                            class="docutils literal notranslate"><span class="pre">SummaryBczBlocks()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.Writer"><code
                                                            class="docutils literal notranslate"><span class="pre">Writer</span></code></a>
                                                        <ul>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.catcz"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.catcz()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.close"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.close()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.create_new_dim"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.create_new_dim()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.fileno"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.fileno()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.flush"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.flush()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.isatty"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.isatty()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.seekable"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.seekable()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.tell"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.tell()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.tocz"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.tocz()</span></code></a></li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.write_chunk"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.write_chunk()</span></code></a>
                                                            </li>
                                                            <li class="toctree-l6"><a class="reference internal"
                                                                                      href="../../czip.cz.html#czip.cz.Writer.write_header"><code
                                                                    class="docutils literal notranslate"><span
                                                                    class="pre">Writer.write_header()</span></code></a>
                                                            </li>
                                                        </ul>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.extract"><code
                                                            class="docutils literal notranslate"><span class="pre">extract()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.get_dtfuncs"><code
                                                            class="docutils literal notranslate"><span class="pre">get_dtfuncs()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.make_virtual_offset"><code
                                                            class="docutils literal notranslate"><span class="pre">make_virtual_offset()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.open1"><code
                                                            class="docutils literal notranslate"><span class="pre">open1()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.split_virtual_offset"><code
                                                            class="docutils literal notranslate"><span class="pre">split_virtual_offset()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.str2byte"><code
                                                            class="docutils literal notranslate"><span class="pre">str2byte()</span></code></a>
                                                    </li>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.cz.html#czip.cz.test_difference"><code
                                                            class="docutils literal notranslate"><span class="pre">test_difference()</span></code></a>
                                                    </li>
                                                </ul>
                                            </li>
                                            <li class="toctree-l4"><a class="reference internal"
                                                                      href="../../czip.test.html">czip.test module</a>
                                                <ul>
                                                    <li class="toctree-l5"><a class="reference internal"
                                                                              href="../../czip.test.html#czip.test.test_bed2cz"><code
                                                            class="docutils literal notranslate"><span class="pre">test_bed2cz()</span></code></a>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="toctree-l3"><a class="reference internal"
                                                              href="../../czip.html#module-czip">Module contents</a>
                                        <ul>
                                            <li class="toctree-l4"><a class="reference internal"
                                                                      href="../../czip.html#czip.main"><code
                                                    class="docutils literal notranslate"><span class="pre">main()</span></code></a>
                                            </li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                            <li class="toctree-l2"><a class="reference internal" href="../../setup.html">setup
                                module</a></li>
                        </ul>
                    </li>
                </ul>

            </div>
        </div>
    </nav>

    <section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
        <nav aria-label="Mobile navigation menu" class="wy-nav-top">
            <i class="fa fa-bars" data-toggle="wy-nav-top"></i>
            <a href="../../index.html">czip</a>
        </nav>

        <div class="wy-nav-content">
            <div class="rst-content">
                <div aria-label="Page navigation" role="navigation">
                    <ul class="wy-breadcrumbs">
                        <li><a aria-label="Home" class="icon icon-home" href="../../index.html"></a></li>
                        <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
                        <li class="breadcrumb-item"><a href="../czip.html">czip</a></li>
                        <li class="breadcrumb-item active">czip.cz</li>
                        <li class="wy-breadcrumbs-aside">
                        </li>
                    </ul>
                    <hr/>
                </div>
                <div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
                    <div itemprop="articleBody">

                        <h1>Source code for czip.cz</h1>
                        <div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">zlib</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span
                                class="nb">open</span> <span class="k">as</span> <span class="n">_open</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="n">_bcz_magic</span> <span class="o">=</span> <span class="sa">b</span><span
                                class="s1">&#39;BMZIP&#39;</span>
<span class="n">_block_magic</span> <span class="o">=</span> <span class="sa">b</span><span
                                class="s2">&quot;MB&quot;</span>
<span class="n">_chunk_magic</span> <span class="o">=</span> <span class="sa">b</span><span
                                class="s2">&quot;MC&quot;</span>
<span class="n">_BLOCK_MAX_LEN</span> <span class="o">=</span> <span class="mi">65535</span>
<span class="n">_bcz_eof</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;</span><span
                                class="se">\x1f\x8b\x08\x04\x00\x00\x00\x00\x00\xff\x06\x00</span><span
                                class="s2">BM</span><span class="se">\x02\x00\x1b\x00\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00</span><span
                                class="s2">&quot;</span>
<span class="n">_version</span> <span class="o">=</span> <span class="mf">1.0</span>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="str2byte"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.str2byte">[docs]</a><span
        class="k">def</span> <span class="nf">str2byte</span><span class="p">(</span><span class="n">x</span><span
        class="p">):</span>
    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span
            class="p">(</span><span class="n">x</span><span class="p">),</span> <span
            class="s1">&#39;utf-8&#39;</span><span class="p">)</span></div>
<span class="c1"># ==========================================================</span>
<span class="n">dtype_func</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;h&#39;</span><span class="p">:</span> <span class="nb">int</span><span
                                class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">:</span> <span
                                class="nb">int</span><span class="p">,</span>
    <span class="s1">&#39;i&#39;</span><span class="p">:</span> <span class="nb">int</span><span
                                class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span> <span
                                class="nb">int</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span
                                class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span
                                class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="nb">int</span><span
                                class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">:</span> <span
                                class="nb">int</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span
                                class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span
                                class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="s1">&#39;f&#39;</span><span class="p">:</span> <span class="nb">float</span><span
                                class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span
                                class="nb">float</span><span class="p">,</span>
    <span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="n">str2byte</span><span class="p">,</span> <span
                                class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="n">str2byte</span>
<span class="p">}</span>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="get_dtfuncs"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.get_dtfuncs">[docs]</a><span
        class="k">def</span> <span class="nf">get_dtfuncs</span><span class="p">(</span><span
        class="n">formats</span><span class="p">,</span><span class="n">tobytes</span><span class="o">=</span><span
        class="kc">True</span><span class="p">):</span>
    <span class="n">D</span><span class="o">=</span><span class="n">dtype_func</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tobytes</span><span class="p">:</span>
        <span class="n">D</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span><span
            class="o">=</span><span class="nb">str</span>
        <span class="n">D</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span><span
            class="o">=</span><span class="nb">str</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">D</span><span class="p">[</span><span
            class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span
            class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">formats</span><span
            class="p">]</span></div>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="make_virtual_offset"><a class="viewcode-back"
                                                        href="../../czip.cz.html#czip.cz.make_virtual_offset">[docs]</a><span
        class="k">def</span> <span class="nf">make_virtual_offset</span><span class="p">(</span><span class="n">block_start_offset</span><span
        class="p">,</span> <span class="n">within_block_offset</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">within_block_offset</span> <span class="o">&lt;</span> <span
            class="mi">0</span> <span class="ow">or</span> <span class="n">within_block_offset</span> <span class="o">&gt;=</span> <span
            class="n">_BLOCK_MAX_LEN</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Require 0 &lt;= within_block_offset &lt; 2**16, got </span><span class="si">%i</span><span
            class="s2">&quot;</span> <span class="o">%</span> <span class="n">within_block_offset</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">block_start_offset</span> <span class="o">&lt;</span> <span
            class="mi">0</span> <span class="ow">or</span> <span class="n">block_start_offset</span> <span class="o">&gt;=</span> <span
            class="mi">2</span><span class="o">**</span><span class="mi">48</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Require 0 &lt;= block_start_offset &lt; 2**48, got </span><span
            class="si">%i</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">block_start_offset</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">block_start_offset</span> <span class="o">&lt;&lt;</span> <span
            class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span
            class="n">within_block_offset</span></div>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="split_virtual_offset"><a class="viewcode-back"
                                                         href="../../czip.cz.html#czip.cz.split_virtual_offset">[docs]</a><span
        class="k">def</span> <span class="nf">split_virtual_offset</span><span class="p">(</span><span class="n">virtual_offset</span><span
        class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">virtual_offset</span> <span
            class="o">&gt;&gt;</span> <span class="mi">16</span>
    <span class="k">return</span> <span class="n">start</span><span class="p">,</span> <span
            class="n">virtual_offset</span> <span class="o">^</span> <span class="p">(</span><span
            class="n">start</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span
            class="p">)</span></div>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="SummaryBczBlocks"><a class="viewcode-back"
                                                     href="../../czip.cz.html#czip.cz.SummaryBczBlocks">[docs]</a><span
        class="k">def</span> <span class="nf">SummaryBczBlocks</span><span class="p">(</span><span
        class="n">handle</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">handle</span><span class="p">,</span> <span class="n">Reader</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Function BczBlocks expects a binary handle&quot;</span><span
            class="p">)</span>
    <span class="n">data_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">start_offset</span> <span class="o">=</span> <span class="n">handle</span><span
            class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block_length</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">=</span> <span
            class="n">_load_bcz_block</span><span class="p">(</span><span class="n">handle</span><span
            class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">yield</span> <span class="n">start_offset</span><span class="p">,</span> <span class="n">block_length</span><span
            class="p">,</span> <span class="n">data_start</span><span class="p">,</span> <span class="n">data_len</span>
        <span class="n">data_start</span> <span class="o">+=</span> <span class="n">data_len</span></div>

<span class="c1"># ==========================================================</span>
<span class="k">def</span> <span class="nf">_load_bcz_block</span><span class="p">(</span><span
                                class="n">handle</span><span class="p">,</span> <span class="n">decompress</span><span
                                class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">magic</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span
                                class="n">read</span><span class="p">(</span><span class="mi">2</span><span
                                class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">magic</span> <span class="ow">or</span> <span
                                class="n">magic</span> <span class="o">!=</span> <span
                                class="n">_block_magic</span><span class="p">:</span>  <span class="c1"># next chunk or EOF</span>
        <span class="k">raise</span> <span class="ne">StopIteration</span>
    <span class="n">block_size</span> <span class="o">=</span> <span class="n">struct</span><span
                                class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span
                                class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span
                                class="p">(</span><span class="mi">2</span><span class="p">))[</span><span
                                class="mi">0</span><span class="p">]</span>
    <span class="c1"># block size is the size of compressed data + 4 (header + tail)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	2 bytes is the size of block_size</span>
<span class="sd">	10 bytes for the GZIP header.</span>
<span class="sd">	2 bytes for the block tail: block_data_len</span>
<span class="sd">	1 byte for the empty GZIP trailer.</span>
<span class="sd">	&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">decompress</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		# there is no gzip header for deflate compressed format</span>
<span class="sd">		to (de-)compress deflate format, use wbits = -zlib.MAX_WBITS (-15)</span>
<span class="sd">		to (de-)compress zlib format, use wbits = zlib.MAX_WBITS</span>
<span class="sd">		to (de-)compress gzip format, use wbits = zlib.MAX_WBITS | 16</span>
<span class="sd">		&quot;&quot;&quot;</span>
        <span class="n">deflate_size</span> <span class="o">=</span> <span class="n">block_size</span> <span
                                class="o">-</span> <span class="mi">6</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span
                                class="n">decompressobj</span><span class="p">(</span><span class="o">-</span><span
                                class="mi">15</span><span class="p">)</span>  <span class="c1"># -zlib.MAX_WBITS, means no headers</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span
                                class="n">decompress</span><span class="p">(</span><span class="n">handle</span><span
                                class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">deflate_size</span><span
                                class="p">))</span> <span class="o">+</span> <span class="n">d</span><span
                                class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span
                                class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span
                                class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span
                                class="p">(</span><span class="mi">2</span><span class="p">))[</span><span
                                class="mi">0</span><span class="p">]</span>
        <span class="c1"># refer to: http://samtools.github.io/hts-specs/SAMv1.pdf</span>
        <span class="c1"># data_len = len(data) #uncompressed data length</span>
        <span class="k">return</span> <span class="n">block_size</span><span class="p">,</span> <span
                                class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span
                                class="n">block_size</span> <span class="o">-</span> <span class="mi">6</span><span
                                class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span
                                class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span
                                class="p">,</span> <span class="n">handle</span><span class="o">.</span><span class="n">read</span><span
                                class="p">(</span><span class="mi">2</span><span class="p">))[</span><span
                                class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">block_size</span><span class="p">,</span> <span
                                class="n">data_len</span>
<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="open1"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.open1">[docs]</a><span
        class="k">def</span> <span class="nf">open1</span><span class="p">(</span><span class="n">infile</span><span
        class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">infile</span><span
            class="p">,</span> <span class="s1">&#39;readline&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">infile</span>
    <span class="k">if</span> <span class="n">infile</span><span class="o">.</span><span class="n">endswith</span><span
            class="p">(</span><span class="s1">&#39;.gz&#39;</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span
            class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span
            class="s1">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span
            class="n">infile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span></div>
<span class="c1"># ==========================================================</span>
<span class="k">def</span> <span class="nf">_gz_input_parser</span><span class="p">(</span><span class="n">infile</span><span
                                class="p">,</span><span class="n">formats</span><span class="p">,</span><span class="n">sep</span><span
                                class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span
                                class="s1">&#39;</span><span class="p">,</span><span class="n">usecols</span><span
                                class="o">=</span><span class="p">[</span><span class="mi">1</span><span
                                class="p">,</span><span class="mi">4</span><span class="p">,</span><span
                                class="mi">5</span><span class="p">],</span><span class="n">dim_cols</span><span
                                class="o">=</span><span class="p">[</span><span class="mi">0</span><span
                                class="p">],</span>
                 <span class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span><span
                                class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">open1</span><span class="p">(</span><span
                                class="n">infile</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span
                                class="n">pre_dims</span> <span class="o">=</span> <span class="p">[],</span> <span
                                class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">dtfuncs</span> <span class="o">=</span> <span class="n">get_dtfuncs</span><span
                                class="p">(</span><span class="n">formats</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span
                                class="n">readline</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span
                                class="n">decode</span><span class="p">(</span><span
                                class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span
                                class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span
                                class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span
                                class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span
                                class="p">)</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span
                                class="p">[</span><span class="n">i</span><span class="p">]</span> <span
                                class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
                                class="n">dim_cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="o">!=</span> <span
                                class="n">pre_dims</span><span class="p">:</span>  <span class="c1"># a new dim (chrom), for example, chr1 -&gt; chr2</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span
                                class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span
                                class="mi">0</span><span class="p">:</span>  <span
                                class="c1"># write rest data of chr1</span>
                <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span
                                class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span
                                class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">usecols</span><span
                                class="p">),</span> <span class="n">pre_dims</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span
                                class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
            <span class="n">pre_dims</span> <span class="o">=</span> <span class="n">dims</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">chunksize</span><span
                                class="p">:</span>  <span class="c1"># dims are the same, but reach chunksize</span>
            <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span
                                class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span
                                class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">usecols</span><span
                                class="p">),</span> <span class="n">pre_dims</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span
                                class="p">[],</span> <span class="mi">0</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span
                                class="n">func</span><span class="p">(</span><span class="n">v</span><span
                                class="p">)</span> <span class="k">for</span> <span class="n">v</span><span
                                class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span
                                class="nb">zip</span><span class="p">([</span><span class="n">values</span><span
                                class="p">[</span><span class="n">i</span><span class="p">]</span> <span
                                class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
                                class="n">usecols</span><span class="p">],</span>
                                                <span class="n">dtfuncs</span><span class="p">)])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span
                                class="n">readline</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span
                                class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span
                                class="p">:</span>
        <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span
                                class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span
                                class="p">,</span> <span class="n">columns</span><span class="o">=</span><span
                                class="n">usecols</span><span class="p">),</span> <span class="n">pre_dims</span>

<span class="c1"># ==========================================================</span>
<span class="k">def</span> <span class="nf">_text_input_parser</span><span class="p">(</span><span
                                class="n">infile</span><span class="p">,</span><span class="n">formats</span><span
                                class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span
                                class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span
                                class="n">usecols</span><span class="o">=</span><span class="p">[</span><span
                                class="mi">1</span><span class="p">,</span><span class="mi">4</span><span
                                class="p">,</span><span class="mi">5</span><span class="p">],</span><span class="n">dim_cols</span><span
                                class="o">=</span><span class="p">[</span><span class="mi">0</span><span
                                class="p">],</span>
                 <span class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span><span
                                class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse text input file (txt, csv, tsv and so on.) into chunks, every chunk has</span>
<span class="sd">    the same dim_cols (for example, chromosomes).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    infile : path</span>
<span class="sd">        input file path or sys.stdin.buffer</span>
<span class="sd">    formats : list</span>
<span class="sd">        list of formats to pack into .cz file.</span>
<span class="sd">    sep :str</span>
<span class="sd">    usecols :list</span>
<span class="sd">        columns index in input file to be packed into .cz file.</span>
<span class="sd">    dim_cols : list</span>
<span class="sd">        dimensions column index, default is [0]</span>
<span class="sd">    chunksize :int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a generator, each element is a tuple, first element of tuple is a dataframe</span>
<span class="sd">     (header names is usecols),second element is the dims,</span>
<span class="sd">    in each dataframe, the dim are the same.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cdef int i, N</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">open1</span><span class="p">(</span><span
                                class="n">infile</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span
                                class="n">pre_dims</span> <span class="o">=</span> <span class="p">[],</span> <span
                                class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">dtfuncs</span> <span class="o">=</span> <span class="n">get_dtfuncs</span><span
                                class="p">(</span><span class="n">formats</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span
                                class="n">readline</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span
                                class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span
                                class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span
                                class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span
                                class="p">)</span>
        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span
                                class="p">[</span><span class="n">i</span><span class="p">]</span> <span
                                class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
                                class="n">dim_cols</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">dims</span> <span class="o">!=</span> <span
                                class="n">pre_dims</span><span class="p">:</span>  <span class="c1"># a new dim (chrom), for example, chr1 -&gt; chr2</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span
                                class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span
                                class="mi">0</span><span class="p">:</span>  <span
                                class="c1"># write rest data of chr1</span>
                <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span
                                class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span
                                class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">usecols</span><span
                                class="p">),</span> <span class="n">pre_dims</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span
                                class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
            <span class="n">pre_dims</span> <span class="o">=</span> <span class="n">dims</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">chunksize</span><span
                                class="p">:</span>  <span class="c1"># dims are the same, but reach chunksize</span>
            <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span
                                class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span
                                class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">usecols</span><span
                                class="p">),</span> <span class="n">pre_dims</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span
                                class="p">[],</span> <span class="mi">0</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span
                                class="n">func</span><span class="p">(</span><span class="n">v</span><span
                                class="p">)</span> <span class="k">for</span> <span class="n">v</span><span
                                class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span
                                class="nb">zip</span><span class="p">([</span><span class="n">values</span><span
                                class="p">[</span><span class="n">i</span><span class="p">]</span> <span
                                class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
                                class="n">usecols</span><span class="p">],</span>
                                                <span class="n">dtfuncs</span><span class="p">)])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span
                                class="n">readline</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span
                                class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">pd</span><span class="o">.</span><span
                                class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span
                                class="p">,</span> <span class="n">columns</span><span class="o">=</span><span
                                class="n">usecols</span><span class="p">),</span> <span class="n">pre_dims</span>


<span class="c1"># ==========================================================</span>
<span class="k">def</span> <span class="nf">_input_parser</span><span class="p">(</span><span
                                class="n">infile</span><span class="p">,</span> <span class="n">formats</span><span
                                class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span
                                class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span
                                class="n">usecols</span><span class="o">=</span><span class="p">[</span><span
                                class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span
                                class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">dim_cols</span><span
                                class="o">=</span><span class="p">[</span><span class="mi">0</span><span
                                class="p">],</span>
                  <span class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span><span
                                class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">infile</span><span
                                class="p">,</span> <span class="s1">&#39;readline&#39;</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_text_input_parser</span><span class="p">(</span><span
                                class="n">infile</span><span class="p">,</span> <span class="n">formats</span><span
                                class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">usecols</span><span
                                class="p">,</span> <span class="n">dim_cols</span><span class="p">,</span> <span
                                class="n">chunksize</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">infile</span><span class="o">.</span><span
                                class="n">endswith</span><span class="p">(</span><span
                                class="s1">&#39;.gz&#39;</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">_gz_input_parser</span><span class="p">(</span><span
                                class="n">infile</span><span class="p">,</span> <span class="n">formats</span><span
                                class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">usecols</span><span
                                class="p">,</span> <span class="n">dim_cols</span><span class="p">,</span> <span
                                class="n">chunksize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">_text_input_parser</span><span class="p">(</span><span
                                class="n">infile</span><span class="p">,</span> <span class="n">formats</span><span
                                class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">usecols</span><span
                                class="p">,</span> <span class="n">dim_cols</span><span class="p">,</span> <span
                                class="n">chunksize</span><span class="p">)</span>


<span class="c1"># ==========================================================</span>
<span class="k">def</span> <span class="nf">_isCG</span><span class="p">(</span><span class="n">record</span><span
                                class="p">):</span>
    <span class="k">return</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span
                                class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span
                                class="o">==</span> <span class="sa">b</span><span class="s1">&#39;CG&#39;</span>


<span class="k">def</span> <span class="nf">_isForwardCG</span><span class="p">(</span><span
                                class="n">record</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">record</span><span class="p">[</span><span class="mi">2</span><span
                                class="p">][:</span><span class="mi">2</span><span class="p">]</span> <span
                                class="o">==</span> <span class="sa">b</span><span class="s1">&#39;CG&#39;</span> <span
                                class="ow">and</span> <span class="n">record</span><span class="p">[</span><span
                                class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span
                                class="sa">b</span><span class="s1">&#39;+&#39;</span>
<span class="c1"># ==========================================================</span>
<span class="k">def</span> <span class="nf">_isCH</span><span class="p">(</span><span class="n">record</span><span
                                class="p">):</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">_isCG</span><span class="p">(</span><span
                                class="n">record</span><span class="p">)</span>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="Reader"><a class="viewcode-back"
                                           href="../../czip.cz.html#czip.cz.Reader">[docs]</a><span
        class="k">class</span> <span class="nc">Reader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">mode</span><span
            class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">,</span> <span
            class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span
            class="n">max_cache</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Initialize the class for reading a BGZF file.</span>
<span class="sd">		You would typically use the top level ``bgzf.open(...)`` function</span>
<span class="sd">		which will call this class internally. Direct use is discouraged.</span>
<span class="sd">		Either the ``filename`` (string) or ``fileobj`` (input file object in</span>
<span class="sd">		binary mode) arguments must be supplied, but not both.</span>
<span class="sd">		Argument ``mode`` controls if the data will be returned as strings in</span>
<span class="sd">		text mode (&quot;rt&quot;, &quot;tr&quot;, or default &quot;r&quot;), or bytes binary mode (&quot;rb&quot;</span>
<span class="sd">		or &quot;br&quot;). The argument name matches the built-in ``open(...)`` and</span>
<span class="sd">		standard library ``gzip.open(...)`` function.</span>
<span class="sd">		If text mode is requested, in order to avoid multi-byte characters,</span>
<span class="sd">		this is hard coded to use the &quot;latin1&quot; encoding, and &quot;\r&quot; and &quot;\n&quot;</span>
<span class="sd">		are passed as is (without implementing universal new line mode). There</span>
<span class="sd">		is no ``encoding`` argument.</span>

<span class="sd">		If your data is in UTF-8 or any other incompatible encoding, you must</span>
<span class="sd">		use binary mode, and decode the appropriate fragments yourself.</span>
<span class="sd">		Argument ``max_cache`` controls the maximum number of BGZF blocks to</span>
<span class="sd">		cache in memory. Each can be up to 64kb thus the default of 100 blocks</span>
<span class="sd">		could take up to 6MB of RAM. This is important for efficient random</span>
<span class="sd">		access, a small value is fine for reading the file in one pass.</span>
<span class="sd">		&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">max_cache</span> <span class="o">&lt;</span> <span class="mi">1</span><span
            class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use max_cache with a minimum of 1&quot;</span><span
            class="p">)</span>
        <span class="c1"># Must open the BGZF file in binary mode, but we may want to</span>
        <span class="c1"># treat the contents as either text or binary (unicode or</span>
        <span class="c1"># bytes under Python 3)</span>
        <span class="k">if</span> <span class="n">Input</span> <span class="ow">and</span> <span
            class="n">fileobj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supply either filename or fileobj, not both&quot;</span><span
            class="p">)</span>
        <span class="c1"># Want to reject output modes like w, a, x, +</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span
            class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span
            class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;tr&quot;</span><span
            class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span
            class="p">,</span> <span class="s2">&quot;br&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Must use a read mode like &#39;r&#39; (default), &#39;rt&#39;, or &#39;rb&#39; for binary&quot;</span>
            <span class="p">)</span>
        <span class="c1"># If an open file was passed, make sure it was opened in binary mode.</span>
        <span class="k">if</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fileobj</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span
            class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fileobj not opened in binary mode&quot;</span><span
            class="p">)</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">fileobj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Input</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span
            class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span
            class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span
            class="n">expanduser</span><span class="p">(</span><span class="n">Input</span><span class="p">))</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">_open</span><span
            class="p">(</span><span class="n">Input</span><span class="p">,</span> <span
            class="s2">&quot;rb&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span> <span
            class="o">=</span> <span class="n">handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Input</span><span class="o">=</span><span
            class="n">Input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cache</span> <span
            class="o">=</span> <span class="n">max_cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_start_offset</span> <span
            class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span> <span
            class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">read_header</span><span class="p">()</span>

<div class="viewcode-block" id="Reader.read_header"><a class="viewcode-back"
                                                       href="../../czip.cz.html#czip.cz.Reader.read_header">[docs]</a>    <span
        class="k">def</span> <span class="nf">read_header</span><span class="p">(</span><span
        class="bp">self</span><span class="p">):</span>
        <span class="c1"># header: magic (5 bytes, 5s)  +</span>
        <span class="c1"># format_len (1byte, B) + format (format_len bytes, s)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span
            class="p">{}</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_handle</span>
        <span class="n">magic</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;5s&quot;</span><span
            class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
        <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span
            class="n">_bcz_magic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not a right format?&quot;</span><span
            class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;magic&#39;</span><span class="p">]</span> <span class="o">=</span> <span
            class="n">magic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span
            class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span
            class="s2">&quot;&lt;f&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="mi">4</span><span class="p">))[</span><span
            class="mi">0</span><span class="p">]</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;Q&quot;</span><span
            class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
        <span class="k">if</span> <span class="n">total_size</span> <span class="o">==</span> <span
            class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File not completed !&quot;</span><span
            class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;total_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_size</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span
            class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span> <span class="c1">#message_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;message&#39;</span><span class="p">]</span> <span class="o">=</span> <span
            class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">n</span><span
            class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">f</span><span
            class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">n</span><span
            class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span
            class="n">decode</span><span class="p">()</span>
        <span class="n">format_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;B&quot;</span><span
            class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
        <span class="n">Formats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
            class="nb">range</span><span class="p">(</span><span class="n">format_len</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;B&quot;</span><span
            class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span
            class="s2">s&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">))[</span><span
            class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span
            class="p">()</span>
            <span class="n">Formats</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="nb">format</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span
            class="n">Formats</span>
        <span class="n">Columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
            class="nb">range</span><span class="p">(</span><span class="n">format_len</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;B&quot;</span><span
            class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span
            class="s2">s&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">))[</span><span
            class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span
            class="p">()</span>
            <span class="n">Columns</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">]</span> <span class="o">=</span> <span
            class="n">Columns</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">Formats</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">Columns</span><span class="p">)</span>
        <span class="n">Dimensions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_dims</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span
            class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
            class="nb">range</span><span class="p">(</span><span class="n">n_dims</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;B&quot;</span><span
            class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span
            class="s2">s&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="n">n</span><span class="p">))[</span><span
            class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span
            class="p">()</span>
            <span class="n">Dimensions</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dimensions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;header_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span
            class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>  <span
            class="c1"># end of header, begin of 1st chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmts</span> <span class="o">=</span> <span
            class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span
            class="n">Formats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span> <span
            class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span
            class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_info</span> <span
            class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary_chunks</span><span
            class="p">(</span><span class="n">printout</span><span class="o">=</span><span class="kc">False</span><span
            class="p">)</span></div>

<div class="viewcode-block" id="Reader.print_header"><a class="viewcode-back"
                                                        href="../../czip.cz.html#czip.cz.Reader.print_header">[docs]</a>    <span
        class="k">def</span> <span class="nf">print_header</span><span class="p">(</span><span
        class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span
            class="s2">&quot; : &quot;</span><span class="p">,</span><span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">k</span><span
            class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_load_chunk</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">start_offset</span><span
            class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jump</span><span
            class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start_offset</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>  <span
            class="c1"># this is another chunk, not the 1st one.</span>
            <span class="n">start_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_end_offset</span>
        <span class="k">if</span> <span class="n">start_offset</span> <span class="o">&gt;=</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;total_size&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">seek</span><span class="p">(</span><span class="n">start_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_start_offset</span> <span
            class="o">=</span> <span class="n">start_offset</span>  <span class="c1"># real offset on disk.</span>
        <span class="n">magic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_handle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span
            class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span
            class="n">_chunk_magic</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span> <span class="o">=</span> <span
            class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span
            class="s1">&#39;&lt;Q&#39;</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
        <span class="c1"># load chunk tail, jump all blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_start_offset</span> <span class="o">+</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_data_len</span> <span
            class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span
            class="p">(</span><span class="s2">&quot;&lt;Q&quot;</span><span class="p">,</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span
            class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_nblocks</span> <span
            class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span
            class="p">(</span><span class="s2">&quot;&lt;Q&quot;</span><span class="p">,</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="mi">8</span><span class="p">))[</span><span
            class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_block_1st_record_virtual_offsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">jump</span><span class="p">:</span>  <span class="c1"># no need to load _chunk_block_1st_record_virtual_offsets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_nblocks</span> <span class="o">*</span> <span
            class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># _chunk_tail_offset = end position of this chunk</span>
        <span class="c1"># = start position of next chunk.</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># query,need to load block 1st record offset</span>
            <span class="c1"># read block_offset</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_nblocks</span><span class="p">):</span>
                <span class="n">block_offset</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span
            class="s2">&quot;&lt;Q&quot;</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="mi">8</span><span class="p">))[</span><span class="mi">0</span><span
            class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span><span
            class="o">.</span><span class="n">append</span><span class="p">(</span><span
            class="n">block_offset</span><span class="p">)</span>
        <span class="n">dims</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Dimensions&#39;</span><span class="p">]:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="s2">&quot;&lt;B&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span
            class="p">))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span
            class="s2">s&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_handle</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span
            class="n">n</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span
            class="o">.</span><span class="n">decode</span><span class="p">()</span>
            <span class="n">dims</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span> <span class="o">=</span> <span
            class="nb">tuple</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_end_offset</span> <span
            class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Reader.get_chunks"><a class="viewcode-back"
                                                      href="../../czip.cz.html#czip.cz.Reader.get_chunks">[docs]</a>    <span
        class="k">def</span> <span class="nf">get_chunks</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;header_size&#39;</span><span
            class="p">],</span> <span class="n">jump</span><span class="o">=</span><span class="kc">False</span><span
            class="p">)</span>
        <span class="k">while</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">[</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_start_offset</span><span class="p">,</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_size</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_data_len</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_end_offset</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_nblocks</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span>
                   <span class="p">]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="n">jump</span><span class="o">=</span><span
            class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Reader.summary_chunks"><a class="viewcode-back"
                                                          href="../../czip.cz.html#czip.cz.Reader.summary_chunks">[docs]</a>    <span
        class="k">def</span> <span class="nf">summary_chunks</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">printout</span><span class="o">=</span><span
        class="kc">True</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;header_size&#39;</span><span
            class="p">],</span> <span class="n">jump</span><span class="o">=</span><span class="kc">True</span><span
            class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chunk_start_offset&#39;</span><span
            class="p">,</span> <span class="s1">&#39;chunk_size&#39;</span><span class="p">,</span> <span class="s1">&#39;chunk_dims&#39;</span><span
            class="p">,</span>
                  <span class="s1">&#39;chunk_tail_offset&#39;</span><span class="p">,</span> <span class="s1">&#39;chunk_nblocks&#39;</span><span
            class="p">,</span> <span class="s1">&#39;chunk_nrows&#39;</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="nb">int</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chunk_data_len</span> <span
            class="o">/</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_unit_size</span><span class="p">)</span>
            <span class="n">record</span> <span class="o">=</span> <span class="p">[</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_start_offset</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_size</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_end_offset</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_nblocks</span><span
            class="p">,</span> <span class="n">nrow</span><span class="p">]</span>
            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span
            class="n">record</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="n">jump</span><span class="o">=</span><span
            class="kc">True</span><span class="p">)</span>
        <span class="n">chunk_info</span> <span class="o">=</span> <span class="n">pd</span><span
            class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span
            class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">header</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="n">chunk_info</span><span class="o">.</span><span
            class="n">chunk_dims</span><span class="o">.</span><span class="n">value_counts</span><span
            class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span
            class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Duplicated chunk dimensions detected,&quot;</span>
                             <span class="s2">&quot;Would cause conflict for querying, please check.&quot;</span><span
            class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span
            class="n">dimension</span> <span class="ow">in</span> <span class="nb">enumerate</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span
            class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span class="p">]):</span>
            <span class="n">chunk_info</span><span class="o">.</span><span class="n">insert</span><span
            class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">dimension</span><span
            class="p">,</span> <span class="n">chunk_info</span><span class="o">.</span><span
            class="n">chunk_dims</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span
            class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="p">))</span>
        <span class="n">chunk_info</span><span class="o">.</span><span class="n">set_index</span><span
            class="p">(</span><span class="s1">&#39;chunk_dims&#39;</span><span class="p">,</span> <span class="n">inplace</span><span
            class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim2chunk_start</span> <span
            class="o">=</span> <span class="n">chunk_info</span><span class="o">.</span><span class="n">chunk_start_offset</span><span
            class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span
            class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span
            class="n">chunk_info</span><span class="o">.</span><span class="n">columns</span><span
            class="o">.</span><span class="n">tolist</span><span class="p">())</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span
            class="ow">in</span> <span class="n">chunk_info</span><span class="o">.</span><span
            class="n">iterrows</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span
            class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span
            class="n">row</span><span class="o">.</span><span class="n">tolist</span><span class="p">()])</span> <span
            class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span
            class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
                    <span class="k">return</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span
            class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">chunk_info</span></div>

<div class="viewcode-block" id="Reader.summary_blocks"><a class="viewcode-back"
                                                          href="../../czip.cz.html#czip.cz.Reader.summary_blocks">[docs]</a>    <span
        class="k">def</span> <span class="nf">summary_blocks</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">printout</span><span class="o">=</span><span
        class="kc">True</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;header_size&#39;</span><span
            class="p">],</span> <span class="n">jump</span><span class="o">=</span><span class="kc">True</span><span
            class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chunk_dims&#39;</span><span
            class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;block_start_offset&#39;</span><span
            class="p">,</span> <span class="s1">&#39;block_size&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;block_data_start&#39;</span><span class="p">,</span> <span
            class="s1">&#39;block_data_len&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span
            class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span
            class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span
            class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">R</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">r</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_start_offset</span> <span class="o">+</span> <span
            class="mi">10</span><span class="p">)</span>
            <span class="n">chunk_info</span> <span class="o">=</span> <span class="p">[</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">SummaryBczBlocks</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="p">):</span>
                <span class="n">block</span> <span class="o">=</span> <span class="n">chunk_info</span> <span class="o">+</span> <span
            class="nb">list</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span
            class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span
            class="n">block</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span
            class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="n">jump</span><span class="o">=</span><span
            class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span
            class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span
            class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span
            class="n">columns</span><span class="o">=</span><span class="n">header</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Reader.chunk2df"><a class="viewcode-back"
                                                    href="../../czip.cz.html#czip.cz.Reader.chunk2df">[docs]</a>    <span
        class="k">def</span> <span class="nf">chunk2df</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">dims</span><span class="p">,</span><span class="n">reformat</span><span
        class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">chunksize</span><span
        class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">dim2chunk_start</span><span class="p">[</span><span
            class="n">dims</span><span class="p">],</span> <span class="n">jump</span><span class="o">=</span><span
            class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span> <span class="o">=</span> <span
            class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">(</span><span class="n">start_offset</span><span class="o">=</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_start_offset</span> <span
            class="o">+</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="n">R</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span> <span
            class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># deal with such case: unit_size is 10, but data(_buffer) size is 18,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span> <span
            class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span>
            <span class="n">end_index</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span
            class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">)</span> <span class="o">%</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span
            class="n">struct</span><span class="o">.</span><span class="n">iter_unpack</span><span
            class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">[:</span><span class="n">end_index</span><span
            class="p">]):</span>
                <span class="n">R</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">chunksize</span> <span
            class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span><span
            class="o">&gt;=</span> <span class="n">chunksize</span><span class="p">:</span>
                <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span
            class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span
            class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span
            class="n">header</span><span class="p">[</span><span class="s1">&#39;Columns&#39;</span><span
            class="p">])</span>
                <span class="n">R</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">yield</span> <span class="n">df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span> <span
            class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">[</span><span class="n">end_index</span><span
            class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">()</span>
            <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">chunksize</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="n">df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span
            class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span
            class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span
            class="n">header</span><span class="p">[</span><span class="s1">&#39;Columns&#39;</span><span
            class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reformat</span><span
            class="p">:</span>
                <span class="k">return</span> <span class="n">df</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="nb">format</span> <span
            class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span
            class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">(),</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span
            class="p">[</span><span class="s1">&#39;Formats&#39;</span><span class="p">]):</span>
                <span class="c1"># print(col,format)</span>
                <span class="k">if</span> <span class="nb">format</span><span class="p">[</span><span class="o">-</span><span
            class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span
            class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span
            class="p">]:</span>
                    <span class="n">df</span><span class="p">[</span><span class="n">col</span><span
            class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span
            class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span
            class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">str</span><span
            class="p">(</span><span class="n">x</span><span class="p">,</span><span
            class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span
            class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">R</span><span
            class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">])</span>
                <span class="k">yield</span> <span class="n">df</span></div>

    <span class="k">def</span> <span class="nf">_load_block</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">start_offset</span><span
            class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">start_offset</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="c1"># If the file is being read sequentially, then _handle.tell()</span>
            <span class="c1"># should be pointing at the start of the next block.</span>
            <span class="c1"># However, if seek has been used, we can&#39;t assume that.</span>
            <span class="n">start_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_block_start_offset</span> <span class="o">+</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span>
        <span class="k">elif</span> <span class="n">start_offset</span> <span class="o">==</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_block_start_offset</span><span
            class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span
            class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>
        <span class="c1"># Now load the block</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">seek</span><span class="p">(</span><span class="n">start_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_start_offset</span> <span
            class="o">=</span> <span class="n">start_offset</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">block_size</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span
            class="n">_load_bcz_block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_handle</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>  <span class="c1"># EOF</span>
            <span class="n">block_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span
            class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span class="o">=</span> <span
            class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span> <span
            class="o">=</span> <span class="n">block_size</span>

    <span class="k">def</span> <span class="nf">_byte2str</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span
            class="n">v</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span
            class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span
            class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span
            class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span
            class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="k">else</span> <span
            class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span
            class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span
            class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">header</span><span class="p">[</span><span class="s1">&#39;Formats&#39;</span><span
            class="p">])]</span>

    <span class="k">def</span> <span class="nf">_byte2real</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span
            class="n">v</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span
            class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span
            class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span
            class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span
            class="s1">&#39;c&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="n">v</span>
                <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span
            class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span
            class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">header</span><span class="p">[</span><span class="s1">&#39;Formats&#39;</span><span
            class="p">])]</span>

    <span class="k">def</span> <span class="nf">_empty_generator</span><span class="p">(</span><span
            class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">[]</span>

<div class="viewcode-block" id="Reader.view"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.view">[docs]</a>    <span
        class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">show_dim</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">True</span><span
        class="p">,</span> <span class="n">Dimension</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span>
             <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span
            class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		View .cz file.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		show_dim : str</span>
<span class="sd">			index of dims given to writer.write_chunk, separated by comma,</span>
<span class="sd">			default is None, dims[show_dim] will be shown in each row (such as sampleID</span>
<span class="sd">			and chrom)</span>
<span class="sd">		header : bool</span>
<span class="sd">			whether to print the header.</span>
<span class="sd">        Dimension: None, bool, list or file path</span>
<span class="sd">            If None (default): use the default chunk order in .cz file; \</span>
<span class="sd">            If list: use this Dimension (dims) as order and print records.\</span>
<span class="sd">            If path: use the first len(Dimension) columns as dim order, there should be\</span>
<span class="sd">                no header in file path and use \t as separator.\</span>
<span class="sd">            If Dimension is dictionary,such as -D &quot;{&#39;sampleID&#39;:&#39;cell1&#39;,&#39;chrom&#39;:&#39;chr1&#39;}&quot;,\</span>
<span class="sd">            will filter chunk using sampleID=cell1 and chrom=chr1.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>

<span class="sd">		&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">show_dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">show_dim</span> <span class="o">=</span> <span class="p">[</span><span
            class="n">show_dim</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">show_dim</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">show_dim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span
            class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span
            class="n">i</span> <span class="ow">in</span> <span class="n">show_dim</span><span class="o">.</span><span
            class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">Dimension</span> <span class="ow">is</span> <span
            class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Dimension</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">chunk_info</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">chunk_info</span><span class="o">.</span><span class="n">copy</span><span
            class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dimension</span><span
            class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">selected_dim</span> <span class="o">=</span> <span class="n">Dimension</span><span
            class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span
            class="n">v</span> <span class="ow">in</span> <span class="n">selected_dim</span><span
            class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">chunk_info</span> <span class="o">=</span> <span class="n">chunk_info</span><span
            class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chunk_info</span><span
            class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span
            class="n">v</span><span class="p">]</span>
            <span class="n">Dimension</span> <span class="o">=</span> <span class="n">chunk_info</span><span
            class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># equal to query chromosome if self.header[&#39;dimensions&#39;][0]==chrom</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dimension</span><span
            class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">order_path</span> <span class="o">=</span> <span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span
            class="n">Dimension</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span
            class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span
            class="n">order_path</span><span class="p">):</span>
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">pd</span><span
            class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span
            class="n">order_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span
            class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span
            class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">usecols</span><span class="o">=</span><span
            class="n">show_dim</span><span class="p">)[</span><span class="n">show_dim</span><span
            class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span
            class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span
            class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">()),</span>
                                                                        <span class="n">axis</span><span
            class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Dimension</span> <span class="o">=</span> <span class="n">Dimension</span><span
            class="o">.</span><span class="n">split</span><span class="p">(</span><span
            class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dimension</span><span
            class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span
            class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span
            class="nb">isinstance</span><span class="p">(</span><span class="n">Dimension</span><span class="p">[</span><span
            class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">Dimension</span> <span class="o">=</span> <span class="p">[</span><span
            class="nb">tuple</span><span class="p">([</span><span class="n">o</span><span class="p">])</span> <span
            class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span
            class="n">Dimension</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span
            class="p">(</span><span class="n">Dimension</span><span class="p">,</span> <span class="p">(</span><span
            class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span
            class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>  <span
            class="c1"># dim is a list</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;input of dim_order is not corrected !&quot;</span><span
            class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">reference</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span
            class="n">reference</span><span class="p">))</span>
            <span class="n">ref_reader</span> <span class="o">=</span> <span class="n">Reader</span><span
            class="p">(</span><span class="n">reference</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show_dim</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="n">header_columns</span> <span class="o">=</span> <span class="p">[</span><span
            class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Dimensions&#39;</span><span class="p">][</span><span class="n">t</span><span
            class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span
            class="n">show_dim</span><span class="p">]</span>
            <span class="n">dim_header</span> <span class="o">=</span> <span class="s2">&quot;</span><span
            class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="n">header_columns</span><span class="p">)</span> <span
            class="o">+</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dim_header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">header</span><span class="p">:</span>  <span
            class="c1"># show header</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reference</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">]</span> <span class="o">+</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">]</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;</span><span
            class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="n">dim_header</span> <span
            class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;</span><span
            class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span
            class="n">Dimension</span><span class="p">:</span>  <span class="c1"># Dimension is a list of tuple ([(d1,d2),(d1,d2)])</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">not</span> <span
            class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">dim2chunk_start</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">show_dim</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dim_stdout</span> <span class="o">=</span> <span class="s2">&quot;</span><span
            class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span
            class="p">([</span><span class="n">d</span><span class="p">[</span><span class="n">t</span><span
            class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span
            class="n">show_dim</span><span class="p">])</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dim_stdout</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">fetch</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reference</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ref_records</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">d</span><span
            class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_empty_generator</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">ref_record</span> <span
            class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">records</span><span
            class="p">,</span> <span class="n">ref_records</span><span class="p">):</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span
            class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span
            class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span
            class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
            class="n">ref_record</span> <span class="o">+</span> <span class="n">record</span><span class="p">])</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">dim_stdout</span> <span class="o">+</span> <span class="n">line</span> <span
            class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span
            class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">reference</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ref_reader</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">return</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;reference </span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span
            class="s2"> not matched.&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span
            class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reference</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_reader</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span></div>

<div class="viewcode-block" id="Reader.category_ssi"><a class="viewcode-back"
                                                        href="../../czip.cz.html#czip.cz.Reader.category_ssi">[docs]</a>    <span
        class="k">def</span> <span class="nf">category_ssi</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span
        class="kc">None</span><span class="p">,</span> <span class="n">formats</span><span class="o">=</span><span
        class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">],</span> <span
        class="n">columns</span><span class="o">=</span><span class="p">[</span><span
        class="s1">&#39;ID&#39;</span><span class="p">],</span>
                     <span class="n">dimensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chrom&#39;</span><span
            class="p">],</span> <span class="n">match_func</span><span class="o">=</span><span
            class="n">_isForwardCG</span><span class="p">,</span>
                     <span class="n">chunksize</span><span class="o">=</span><span class="mi">2000</span><span
            class="p">):</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">Input</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span
            class="o">+</span> <span class="n">match_func</span><span class="o">.</span><span class="vm">__name__</span> <span
            class="o">+</span> <span class="s1">&#39;.ssi&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span
            class="n">output</span><span class="p">))</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span
            class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">Formats</span><span
            class="o">=</span><span class="n">formats</span><span class="p">,</span> <span class="n">Columns</span><span
            class="o">=</span><span class="n">columns</span><span class="p">,</span>
                        <span class="n">Dimensions</span><span class="o">=</span><span class="n">dimensions</span><span
            class="p">,</span> <span class="n">fileobj</span><span class="o">=</span><span class="kc">None</span><span
            class="p">,</span>
                        <span class="n">message</span><span class="o">=</span><span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Input</span><span
            class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">dim2chunk_start</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">dim</span><span
            class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span
            class="s1">&#39;</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span
            class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span
            class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span
            class="n">record</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">__fetch__</span><span class="p">(</span><span
            class="n">dim</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">match_func</span><span class="p">(</span><span class="n">record</span><span
            class="p">):</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">writer</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span
            class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span
            class="o">%</span> <span class="n">chunksize</span><span class="p">)</span> <span class="o">==</span> <span
            class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span
            class="p">:</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">write_chunk</span><span
            class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span
            class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span
            class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write_chunk</span><span
            class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span
            class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Reader.get_ids_from_ssi"><a class="viewcode-back"
                                                            href="../../czip.cz.html#czip.cz.Reader.get_ids_from_ssi">[docs]</a>    <span
        class="k">def</span> <span class="nf">get_ids_from_ssi</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">])</span> <span class="o">==</span> <span
            class="mi">1</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span
            class="mi">0</span><span class="p">,</span> <span class="mi">1</span>  <span class="c1"># only one columns, ID</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span
            class="n">array</span><span class="p">([</span><span class="n">record</span><span class="p">[</span><span
            class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span
            class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">__fetch__</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span
            class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span
            class="n">e</span><span class="o">=</span><span class="n">e</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># two columns: ID_start, ID_end</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span
            class="mi">0</span><span class="p">,</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span
            class="n">array</span><span class="p">([</span><span class="n">record</span> <span
            class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">__fetch__</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span
            class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span
            class="n">e</span><span class="p">)])</span></div>

    <span class="k">def</span> <span class="nf">_getRecordsByIds</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span
            class="kc">None</span><span class="p">,</span> <span class="n">IDs</span><span class="o">=</span><span
            class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dim : tuple</span>
<span class="sd">        reference : path</span>
<span class="sd">        IDs : np.array</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_chunk</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim2chunk_start</span><span
            class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">jump</span><span
            class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">block_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">IDs</span> <span
            class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">)</span> <span class="o">//</span> <span class="p">(</span><span
            class="n">_BLOCK_MAX_LEN</span><span class="p">)</span>
        <span class="n">block_start_offsets</span> <span class="o">=</span> <span class="n">np</span><span
            class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span><span class="p">[</span>
                                            <span class="n">idx</span><span class="p">]</span> <span
            class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="k">for</span> <span
            class="n">idx</span> <span class="ow">in</span> <span class="n">block_index</span><span class="p">])</span>
        <span class="n">within_block_offsets</span> <span class="o">=</span> <span class="p">((</span><span class="n">IDs</span> <span
            class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">)</span> <span class="o">%</span> <span class="p">(</span><span
            class="n">_BLOCK_MAX_LEN</span><span class="p">)</span>
        <span class="n">block_start_offset_tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">block_start_offset</span><span class="p">,</span> <span class="n">within_block_offset</span> <span
            class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">block_start_offsets</span><span class="p">,</span> <span
            class="n">within_block_offsets</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">block_start_offset</span> <span class="o">!=</span> <span
            class="n">block_start_offset_tmp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">(</span><span class="n">block_start_offset</span><span class="p">)</span>
                <span class="n">block_start_offset_tmp</span> <span class="o">=</span> <span class="n">block_start_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span
            class="o">=</span> <span class="n">within_block_offset</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">)</span>

<div class="viewcode-block" id="Reader.getRecordsByIds"><a class="viewcode-back"
                                                           href="../../czip.cz.html#czip.cz.Reader.getRecordsByIds">[docs]</a>    <span
        class="k">def</span> <span class="nf">getRecordsByIds</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">reference</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">IDs</span><span class="o">=</span><span class="kc">None</span><span
        class="p">):</span>
        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_getRecordsByIds</span><span
            class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">IDs</span><span
            class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_byte2real</span><span
            class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span
            class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span>
                <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_reader</span> <span class="o">=</span> <span class="n">Reader</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span
            class="p">(</span><span class="n">reference</span><span class="p">)))</span>
            <span class="n">ref_records</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">_getRecordsByIds</span><span class="p">(</span><span
            class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span
            class="n">IDs</span><span class="o">=</span><span class="n">IDs</span><span class="p">)</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_getRecordsByIds</span><span class="p">(</span><span class="n">dim</span><span
            class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">IDs</span><span
            class="o">=</span><span class="n">IDs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ref_record</span><span class="p">,</span> <span
            class="n">record</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span
            class="n">ref_records</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">ref_reader</span><span class="o">.</span><span class="n">_byte2real</span><span
            class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span
            class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">ref_reader</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="n">ref_record</span>
                <span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_byte2real</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span>
                <span class="p">))</span>
            <span class="n">ref_reader</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_getRecordsByIdRegions</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="kc">None</span><span
            class="p">,</span> <span class="n">IDs</span><span class="o">=</span><span class="kc">None</span><span
            class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get .cz content for a given dim and IDs</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dim : tuple</span>
<span class="sd">        reference : path</span>
<span class="sd">        IDs : list or np.ndarray</span>
<span class="sd">            every element of IDs is a list or tuple with length=2, id_start and id_end</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_chunk</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim2chunk_start</span><span
            class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">jump</span><span
            class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">block_start_offsets_tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">id_start</span><span class="p">,</span> <span class="n">id_end</span> <span
            class="ow">in</span> <span class="n">IDs</span><span class="p">:</span>
            <span class="n">block_index</span> <span class="o">=</span> <span class="p">((</span><span class="n">id_start</span> <span
            class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">)</span> <span class="o">//</span> <span class="p">(</span><span
            class="n">_BLOCK_MAX_LEN</span><span class="p">)</span>
            <span class="n">block_start_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span><span class="p">[</span>
                                     <span class="n">block_index</span><span class="p">]</span> <span
            class="o">&gt;&gt;</span> <span class="mi">16</span>
            <span class="k">if</span> <span class="n">block_start_offset</span> <span class="o">!=</span> <span
            class="n">block_start_offsets_tmp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">(</span><span class="n">block_start_offset</span><span class="p">)</span>
                <span class="n">block_start_offsets_tmp</span> <span class="o">=</span> <span class="n">block_start_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span
            class="o">=</span> <span class="p">((</span><span class="n">id_start</span> <span class="o">-</span> <span
            class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_unit_size</span>
                                         <span class="p">)</span> <span class="o">%</span> <span class="n">_BLOCK_MAX_LEN</span>
            <span class="k">yield</span> <span class="p">[</span><span class="bp">self</span><span
            class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_unit_size</span><span class="p">)</span> <span class="k">for</span> <span
            class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span
            class="n">id_start</span><span class="p">,</span> <span class="n">id_end</span> <span
            class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

<div class="viewcode-block" id="Reader.getRecordsByIdRegions"><a class="viewcode-back"
                                                                 href="../../czip.cz.html#czip.cz.Reader.getRecordsByIdRegions">[docs]</a>    <span
        class="k">def</span> <span class="nf">getRecordsByIdRegions</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span
        class="kc">None</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span
        class="kc">None</span><span class="p">,</span> <span class="n">IDs</span><span class="o">=</span><span
        class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get .cz content for a given dim and IDs</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dim : tuple</span>
<span class="sd">        reference : path</span>
<span class="sd">        IDs : list or np.ndarray</span>
<span class="sd">            every element of IDs is a list or tuple with length=2, id_start and id_end</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_chunk</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim2chunk_start</span><span
            class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">jump</span><span
            class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">records</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_getRecordsByIdRegions</span><span
            class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">IDs</span><span
            class="p">):</span>
                <span class="k">yield</span> <span class="n">np</span><span class="o">.</span><span
            class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_byte2real</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span><span
            class="p">))</span> <span class="k">for</span> <span class="n">record</span> <span
            class="ow">in</span> <span class="n">records</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_reader</span> <span class="o">=</span> <span class="n">Reader</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span
            class="p">(</span><span class="n">reference</span><span class="p">)))</span>
            <span class="n">ref_records</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">_getRecordsByIdRegions</span><span class="p">(</span><span
            class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span> <span
            class="n">IDs</span><span class="o">=</span><span class="n">IDs</span><span class="p">)</span>
            <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_getRecordsByIdRegions</span><span class="p">(</span><span class="n">dim</span><span
            class="o">=</span><span class="n">dim</span><span class="p">,</span> <span class="n">IDs</span><span
            class="o">=</span><span class="n">IDs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ref_records</span><span class="p">,</span> <span class="n">records</span> <span
            class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span
            class="n">ref_records</span><span class="p">,</span> <span class="n">records</span><span class="p">):</span>
                <span class="n">ref_record</span> <span class="o">=</span> <span class="n">np</span><span
            class="o">.</span><span class="n">array</span><span class="p">([</span><span
            class="n">ref_reader</span><span class="o">.</span><span class="n">_byte2real</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">ref_reader</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="n">record</span><span class="p">))</span> <span class="k">for</span> <span
            class="n">record</span> <span class="ow">in</span> <span class="n">ref_records</span><span
            class="p">])</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span
            class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_byte2real</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="n">record</span><span
            class="p">))</span> <span class="k">for</span> <span class="n">record</span> <span
            class="ow">in</span> <span class="n">records</span><span class="p">])</span>
                <span class="k">yield</span> <span class="n">np</span><span class="o">.</span><span
            class="n">hstack</span><span class="p">((</span><span class="n">ref_record</span><span
            class="p">,</span> <span class="n">record</span><span class="p">))</span>
            <span class="n">ref_reader</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span></div>

<div class="viewcode-block" id="Reader.subset"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.subset">[docs]</a>    <span
        class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">ssi</span><span class="o">=</span><span
        class="kc">None</span><span class="p">,</span> <span class="n">IDs</span><span class="o">=</span><span
        class="kc">None</span><span class="p">,</span> <span class="n">reference</span><span class="o">=</span><span
        class="kc">None</span><span class="p">,</span> <span class="n">printout</span><span class="o">=</span><span
        class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="nb">tuple</span><span
            class="p">([</span><span class="n">dim</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">ssi</span> <span class="ow">is</span> <span
            class="kc">None</span> <span class="ow">and</span> <span class="n">IDs</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide either ssi or IDs&quot;</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ssi</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ssi_reader</span> <span class="o">=</span> <span class="n">Reader</span><span
            class="p">(</span><span class="n">ssi</span><span class="p">)</span>
            <span class="n">IDs</span> <span class="o">=</span> <span class="n">ssi_reader</span><span
            class="o">.</span><span class="n">get_ids_from_ssi</span><span class="p">(</span><span
            class="n">dim</span><span class="p">)</span>
            <span class="n">ssi_reader</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">reference</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ref_reader</span> <span class="o">=</span> <span class="n">Reader</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span
            class="p">(</span><span class="n">reference</span><span class="p">)))</span>
            <span class="n">ref_header</span> <span class="o">=</span> <span class="n">ref_reader</span><span class="o">.</span><span
            class="n">header</span><span class="p">[</span><span class="s1">&#39;Columns&#39;</span><span
            class="p">]</span>
            <span class="n">ref_reader</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref_header</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">header</span><span class="p">[</span><span class="s1">&#39;Dimensions&#39;</span><span
            class="p">]</span> <span class="o">+</span> <span class="n">ref_header</span> <span class="o">+</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span
            class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span
            class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">getRecordsByIds</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span
            class="n">IDs</span><span class="p">):</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dim</span><span
            class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span
            class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span
            class="n">record</span><span class="p">)))</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="c1"># print(list(dim)+list(map(str,record)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
                    <span class="k">return</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># each element is one record</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRecordsByIds</span><span
            class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">reference</span><span
            class="p">,</span> <span class="n">IDs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">getRecordsByIdRegions</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span
            class="n">IDs</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span
            class="n">data</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dim</span><span
            class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span
            class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span
            class="n">row</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;</span><span
            class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
                    <span class="k">return</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># each element is a data array (multiple records)</span>
                <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRecordsByIdRegions</span><span
            class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">reference</span><span
            class="p">,</span> <span class="n">IDs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__fetch_deprecated__</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span
            class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span
            class="n">e</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator for a given dims</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dims : tuple</span>
<span class="sd">            element length of dims should match the Dimensions in header[&#39;Dimensions&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span
            class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span
            class="n">s</span>  <span class="c1"># 0-based</span>
        <span class="n">e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">])</span> <span class="k">if</span> <span
            class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span
            class="n">e</span>  <span class="c1"># 1-based</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">dim2chunk_start</span><span class="p">[</span><span
            class="n">dims</span><span class="p">],</span> <span class="n">jump</span><span class="o">=</span><span
            class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span> <span class="o">=</span> <span
            class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="c1"># unit_nblock = int(self._unit_size / (math.gcd(self._unit_size, _BLOCK_MAX_LEN)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">(</span><span class="n">start_offset</span><span class="o">=</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_start_offset</span> <span
            class="o">+</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span> <span
            class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span> <span
            class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span>
            <span class="n">end_index</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span
            class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">)</span> <span class="o">%</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span
            class="n">struct</span><span class="o">.</span><span class="n">iter_unpack</span><span
            class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">[:</span><span class="n">end_index</span><span
            class="p">]):</span>
                <span class="k">yield</span> <span class="n">result</span><span class="p">[</span><span
            class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span>  <span
            class="c1"># a tuple</span>
                <span class="c1"># print(result)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cached_data</span> <span
            class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_cached_data</span><span class="p">[</span><span class="n">end_index</span><span
            class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">()</span>

    <span class="k">def</span> <span class="nf">__fetch__</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span
            class="n">s</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span
            class="n">e</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator for a given dims</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dims : tuple</span>
<span class="sd">            element length of dims should match the Dimensions in header[&#39;Dimensions&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span
            class="n">s</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span
            class="n">s</span>  <span class="c1"># 0-based</span>
        <span class="n">e</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">])</span> <span class="k">if</span> <span
            class="n">e</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span
            class="n">e</span>  <span class="c1"># 1-based</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">dim2chunk_start</span><span class="p">[</span><span
            class="n">dims</span><span class="p">],</span> <span class="n">jump</span><span class="o">=</span><span
            class="kc">True</span><span class="p">)</span>
        <span class="n">unit_nblock</span> <span class="o">=</span> <span class="nb">int</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_unit_size</span> <span class="o">/</span> <span class="p">(</span><span
            class="n">math</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">,</span> <span class="n">_BLOCK_MAX_LEN</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">(</span><span class="n">start_offset</span><span class="o">=</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_start_offset</span> <span
            class="o">+</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">_cached_data</span> <span
            class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span> <span
            class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span
            class="n">unit_nblock</span><span class="p">:</span>
                <span class="n">_cached_data</span> <span class="o">+=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">iter_unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="n">_cached_data</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">result</span><span class="p">[</span><span
            class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span>  <span
            class="c1"># a tuple</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">_cached_data</span> <span
            class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cached_data</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span
            class="n">struct</span><span class="o">.</span><span class="n">iter_unpack</span><span
            class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="n">_cached_data</span><span
            class="p">):</span>
                <span class="k">yield</span> <span class="n">result</span><span class="p">[</span><span
            class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span>  <span
            class="c1"># a tuple</span>

<div class="viewcode-block" id="Reader.fetch"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.fetch">[docs]</a>    <span
        class="k">def</span> <span class="nf">fetch</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">dims</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">__fetch__</span><span class="p">(</span><span class="n">dims</span><span
            class="p">):</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_byte2real</span><span class="p">(</span><span class="n">record</span><span
            class="p">)</span>  <span class="c1"># all columns of each row</span></div>

<div class="viewcode-block" id="Reader.batch_fetch"><a class="viewcode-back"
                                                       href="../../czip.cz.html#czip.cz.Reader.batch_fetch">[docs]</a>    <span
        class="k">def</span> <span class="nf">batch_fetch</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span
        class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span
            class="n">dims</span><span class="p">):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span
            class="n">chunksize</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">data</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span
            class="o">=</span> <span class="p">[],</span> <span class="mi">0</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Reader.fetchByStartID"><a class="viewcode-back"
                                                          href="../../czip.cz.html#czip.cz.Reader.fetchByStartID">[docs]</a>    <span
        class="k">def</span> <span class="nf">fetchByStartID</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span
        class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span
        class="c1"># n is 1-based, n &gt;=1</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">dims</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">dims</span> <span class="o">=</span> <span class="nb">tuple</span><span
            class="p">([</span><span class="n">dims</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_load_chunk</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">dim2chunk_start</span><span class="p">[</span><span
            class="n">dims</span><span class="p">],</span> <span class="n">jump</span><span class="o">=</span><span
            class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>  <span class="c1"># seek to the position of the n rows</span>
            <span class="n">block_index</span> <span class="o">=</span> <span class="p">((</span><span
            class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span
            class="o">*</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_unit_size</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span
            class="n">_BLOCK_MAX_LEN</span><span class="p">)</span>
            <span class="n">first_record_vos</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span><span
            class="p">[</span><span class="n">block_index</span><span class="p">]</span>
            <span class="n">within_block_offset</span> <span class="o">=</span> <span class="p">((</span><span
            class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span
            class="o">*</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_unit_size</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span
            class="n">_BLOCK_MAX_LEN</span><span class="p">)</span>
            <span class="n">block_start_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_record_vos</span> <span
            class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">virtual_start_offset</span> <span class="o">=</span> <span class="p">(</span><span
            class="n">block_start_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span
            class="p">)</span> <span class="o">|</span> <span class="n">within_block_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span
            class="n">virtual_start_offset</span><span class="p">)</span>  <span
            class="c1"># load_block is inside sek</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># yield self._read_1record()</span>
            <span class="k">yield</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_read_1record</span><span class="p">(</span><span class="bp">self</span><span
            class="p">):</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_buffer</span><span class="p">[</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span><span
            class="p">:</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_within_block_offset</span> <span class="o">+</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_unit_size</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span class="o">+=</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span
            class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_query_regions</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span
            class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        query given regions, start and end index to the columns of data columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        regions : list</span>
<span class="sd">            list of list, first element is a tuple (dims), second is start, third is end,.</span>
<span class="sd">        s : int</span>
<span class="sd">        e : int</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Return a generator, the first element of generator is start offset of the</span>
<span class="sd">        1st record.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dim_tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">start</span><span
            class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">regions</span><span
            class="p">:</span>
            <span class="k">if</span> <span class="n">dim</span> <span class="o">!=</span> <span
            class="n">dim_tmp</span><span class="p">:</span>
                <span class="c1"># start_block_index_tmp = 0</span>
                <span class="n">start_block_index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dim_tmp</span> <span class="o">=</span> <span class="n">dim</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_load_chunk</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">dim2chunk_start</span><span class="p">[</span><span
            class="n">dim</span><span class="p">],</span> <span class="n">jump</span><span class="o">=</span><span
            class="kc">False</span><span class="p">)</span>
                <span class="c1"># find the closest block to a given start position</span>
                <span class="n">block_1st_starts</span> <span class="o">=</span> <span class="n">np</span><span
            class="o">.</span><span class="n">array</span><span class="p">([</span>
                    <span class="bp">self</span><span class="o">.</span><span
            class="n">_seek_and_read_1record</span><span class="p">(</span><span class="n">offset</span><span class="p">)[</span><span
            class="n">s</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span>
                <span class="p">])</span>
            <span class="c1"># for idx in range(start_block_index_tmp, self._chunk_nblocks-1):</span>
            <span class="c1">#     if block_1st_starts[idx + 1] &gt; start:</span>
            <span class="c1">#         start_block_index = idx</span>
            <span class="c1">#         break</span>
            <span class="c1">#     start_block_index = self._chunk_nblocks - 1</span>
            <span class="k">while</span> <span class="n">start_block_index</span> <span class="o">&lt;</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_nblocks</span> <span class="o">-</span> <span
            class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">block_1st_starts</span><span class="p">[</span><span
            class="n">start_block_index</span> <span class="o">+</span> <span class="mi">1</span><span
            class="p">]</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">start_block_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># start_block_index=np.argmax(block_1st_starts &gt; start)-1</span>
            <span class="n">virtual_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span><span
            class="p">[</span><span class="n">start_block_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span
            class="n">virtual_offset</span><span class="p">)</span>  <span class="c1"># seek to the target block, self._buffer</span>
            <span class="n">block_start_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_block_start_offset</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">))</span>
            <span class="k">while</span> <span class="n">record</span><span class="p">[</span><span
            class="n">s</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">start</span><span
            class="p">:</span>
                <span class="c1"># record = self._read_1record()</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">))</span>
            <span class="c1"># here we got the 1st record, return the id (row number) of 1st record.</span>
            <span class="c1"># size of each block is 65535 (2**16-1=_BLOCK_MAX_LEN)</span>
            <span class="c1"># primary_id = int((_BLOCK_MAX_LEN * block_index +</span>
            <span class="c1">#                   self._within_block_offset) / self._unit_size)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_start_offset</span> <span
            class="o">&gt;</span> <span class="n">block_start_offset</span><span class="p">:</span>
                <span class="n">start_block_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">primary_id</span> <span class="o">=</span> <span class="nb">int</span><span
            class="p">((</span><span class="n">_BLOCK_MAX_LEN</span> <span class="o">*</span> <span class="n">start_block_index</span> <span
            class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span
            class="n">_within_block_offset</span><span class="p">)</span> <span class="o">/</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span class="p">)</span>
            <span class="c1"># primary_id is the current record (record[s] == start),</span>
            <span class="c1"># with_block_offset is the end of current record</span>
            <span class="c1"># 1-based, primary_id &gt;=1, cause _within_block_offset &gt;= self._unit_size</span>
            <span class="k">yield</span> <span class="s2">&quot;primary_id_&amp;_dim:&quot;</span><span
            class="p">,</span> <span class="n">primary_id</span><span class="p">,</span> <span class="n">dim</span>
            <span class="k">while</span> <span class="n">record</span><span class="p">[</span><span
            class="n">e</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">end</span><span
            class="p">:</span>
                <span class="k">yield</span> <span class="n">dim</span><span class="p">,</span> <span
            class="n">record</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">))</span>
            <span class="n">start_block_index_tmp</span> <span class="o">=</span> <span
            class="n">start_block_index</span>

<div class="viewcode-block" id="Reader.pos2id"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.pos2id">[docs]</a>    <span
        class="k">def</span> <span class="nf">pos2id</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">positions</span><span
        class="p">,</span> <span class="n">col_to_query</span><span class="o">=</span><span class="mi">0</span><span
        class="p">):</span>  <span class="c1"># return IDs (primary_id)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_chunk</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim2chunk_start</span><span
            class="p">[</span><span class="n">dim</span><span class="p">],</span> <span class="n">jump</span><span
            class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">block_1st_starts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_seek_and_read_1record</span><span
            class="p">(</span><span class="n">offset</span><span class="p">)[</span><span
            class="n">col_to_query</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span>
        <span class="p">]</span>
        <span class="n">start_block_index_tmp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span
            class="n">positions</span><span class="p">:</span>  <span class="c1"># positions is sorted, [[0,1],[3,4],[7,8]]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span
            class="nb">range</span><span class="p">(</span><span class="n">start_block_index_tmp</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_nblocks</span> <span
            class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">block_1st_starts</span><span class="p">[</span><span
            class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span
            class="o">&gt;</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">start_block_index</span> <span class="o">=</span> <span class="n">idx</span>
                    <span class="k">break</span>
                <span class="n">start_block_index</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_nblocks</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">virtual_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_chunk_block_1st_record_virtual_offsets</span><span
            class="p">[</span><span class="n">start_block_index</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span
            class="n">virtual_offset</span><span class="p">)</span>  <span class="c1"># seek to the target block, self._buffer</span>
            <span class="n">block_start_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_block_start_offset</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">))</span>
            <span class="k">while</span> <span class="n">record</span><span class="p">[</span><span class="n">col_to_query</span><span
            class="p">]</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span
            class="o">.</span><span class="n">fmts</span><span class="si">}</span><span class="s2">&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span
            class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_start_offset</span> <span
            class="o">&gt;</span> <span class="n">block_start_offset</span><span class="p">:</span>
                <span class="n">start_block_index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">primary_id</span> <span class="o">=</span> <span class="nb">int</span><span
            class="p">((</span><span class="n">_BLOCK_MAX_LEN</span> <span class="o">*</span> <span class="n">start_block_index</span> <span
            class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span
            class="n">_within_block_offset</span><span class="p">)</span> <span class="o">/</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span><span class="p">)</span>
            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span
            class="n">primary_id</span><span class="p">)</span>
            <span class="n">start_block_index_tmp</span> <span class="o">=</span> <span
            class="n">start_block_index</span>
        <span class="k">return</span> <span class="n">R</span></div>

<div class="viewcode-block" id="Reader.query"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.query">[docs]</a>    <span
        class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">Dimension</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">Regions</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span>
              <span class="n">query_col</span><span class="o">=</span><span class="p">[</span><span
            class="mi">0</span><span class="p">],</span> <span class="n">reference</span><span class="o">=</span><span
            class="kc">None</span><span class="p">,</span> <span class="n">printout</span><span class="o">=</span><span
            class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        query .cz file by Dimension, start and end, if regions provided, Dimension, start and</span>
<span class="sd">        end should be None, regions should be a list, each element of regions</span>
<span class="sd">        is a list, for example, regions=[[(&#39;cell1&#39;,&#39;chr1&#39;),1,10],</span>
<span class="sd">        [(&#39;cell10&#39;,&#39;chr22&#39;),100,200]],and so on.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Dimension : str</span>
<span class="sd">            dimension, such as chr1 (if Dimensions &#39;chrom&#39; is inlcuded in</span>
<span class="sd">            header[&#39;Dimensions&#39;]), or sample1 (if something like &#39;sampleID&#39; is</span>
<span class="sd">            included in header[&#39;Dimensions&#39;] and chunk contains such dimension)</span>
<span class="sd">        start : int</span>
<span class="sd">            start position, if None, the entire Dimension would be returned.</span>
<span class="sd">        end : int</span>
<span class="sd">            end position</span>
<span class="sd">        regions : list or file path</span>
<span class="sd">            regions=[</span>
<span class="sd">                [Dimension,start,end], [Dimension,start,end]</span>
<span class="sd">            ],</span>
<span class="sd">            Dimension is a tuple, for example, Dimension=(&#39;chr1&#39;);</span>

<span class="sd">            if regions is a file path (separated by tab and no header),</span>
<span class="sd">            the first len(header[&#39;Dimensions&#39;]) columns would be</span>
<span class="sd">            used as Dimension, and next two columns would be used as start and end.</span>
<span class="sd">        query_col: list</span>
<span class="sd">            index of columns (header[&#39;Columns&#39;]) to be queried,for example,</span>
<span class="sd">            if header[&#39;Columns&#39;]=[&#39;pos&#39;,&#39;mv&#39;,&#39;cov&#39;], then pos is what we want to</span>
<span class="sd">            query, so query_col should be [0], but if</span>
<span class="sd">            header[&#39;Columns&#39;]=[&#39;start&#39;,&#39;end&#39;,&#39;peak&#39;], then start and end are what</span>
<span class="sd">            we would like to query, query_col should be [0,1]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Dimension</span> <span class="ow">is</span> <span
            class="kc">None</span> <span class="ow">and</span> <span class="n">Regions</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide either Dimension,start,end or regions&quot;</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span
            class="n">Dimension</span> <span class="ow">is</span> <span class="kc">None</span><span
            class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span
            class="n">Regions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please query by Dimension,start,end or by regions, &quot;</span>
                             <span class="s2">&quot;not both !&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Dimension</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">start</span> <span
            class="ow">is</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">end</span> <span
            class="ow">is</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dimension</span><span
            class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">Dimension</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span
            class="n">Dimension</span><span class="p">])</span>
                <span class="n">Regions</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Dimension</span><span
            class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span
            class="p">]]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Dimension</span><span
            class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">chunk_info</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">chunk_info</span><span class="o">.</span><span class="n">copy</span><span
            class="p">()</span>
                <span class="n">selected_dim</span> <span class="o">=</span> <span class="n">Dimension</span><span
            class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span
            class="n">v</span> <span class="ow">in</span> <span class="n">selected_dim</span><span
            class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">chunk_info</span> <span class="o">=</span> <span class="n">chunk_info</span><span
            class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">chunk_info</span><span
            class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span
            class="n">v</span><span class="p">]</span>
                <span class="n">Dimension</span> <span class="o">=</span> <span class="n">chunk_info</span><span
            class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">()</span>
                <span class="n">Regions</span> <span class="o">=</span> <span class="p">[[</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span
            class="n">end</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span
            class="ow">in</span> <span class="n">Dimension</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Regions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">region_path</span> <span class="o">=</span> <span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span
            class="n">Regions</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span
            class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span
            class="n">region_path</span><span class="p">):</span>
                    <span class="n">n_dim</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Dimensions&#39;</span><span class="p">]</span>
                    <span class="n">usecols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span
            class="nb">range</span><span class="p">(</span><span class="n">n_dim</span> <span class="o">+</span> <span
            class="mi">2</span><span class="p">))</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span
            class="n">read_csv</span><span class="p">(</span><span class="n">region_path</span><span class="p">,</span> <span
            class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span
            class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span
            class="kc">None</span><span class="p">,</span>
                                     <span class="n">usecols</span><span class="o">=</span><span
            class="n">usecols</span><span class="p">)</span>
                    <span class="n">Regions</span> <span class="o">=</span> <span class="n">df</span><span
            class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span
            class="n">x</span><span class="p">:</span> <span class="p">[</span>
                        <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span
            class="p">[:</span><span class="n">n_dim</span><span class="p">]),</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">n_dim</span><span
            class="p">],</span>
                        <span class="n">x</span><span class="p">[</span><span class="n">n_dim</span> <span
            class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span
            class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;path </span><span class="si">{</span><span
            class="n">region_path</span><span class="si">}</span><span class="s2"> not existed.&quot;</span><span
            class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># check format of regions</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Regions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span
            class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span
            class="s2">&quot;The first element of first region is not a tuple&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">query_col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span
            class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">e</span> <span class="o">=</span> <span
            class="n">query_col</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">query_col</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span
            class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span
            class="n">query_col</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;length of query_col can not be greater then 2.&quot;</span><span
            class="p">)</span>

        <span class="k">if</span> <span class="n">reference</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>  <span class="c1"># query position in this .cz file.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span
            class="nb">set</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span
            class="n">e</span><span class="p">]):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">header</span><span class="p">[</span><span class="s1">&#39;Formats&#39;</span><span
            class="p">][</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span
            class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span
            class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span
            class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span
            class="s2">&quot;The query_col of Columns is not int or float&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;Can not perform querying without reference!&quot;</span><span
            class="p">,</span>
                                     <span class="sa">f</span><span class="s2">&quot;Columns: </span><span
            class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span
            class="p">[</span><span class="s1">&#39;Columns&#39;</span><span class="p">]</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span>
                                     <span class="sa">f</span><span class="s2">&quot;Formats: </span><span
            class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span
            class="p">[</span><span class="s1">&#39;Formats&#39;</span><span class="p">]</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Dimensions&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_query_regions</span><span class="p">(</span><span
            class="n">Regions</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span
            class="n">e</span><span class="p">)</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">records</span><span
            class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="n">records</span><span
            class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dims</span><span class="p">,</span> <span class="n">row</span> <span
            class="o">=</span> <span class="n">record</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span
            class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span
            class="n">dims</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="bp">self</span><span class="o">.</span><span
            class="n">_byte2str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span> <span
            class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span
            class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
                            <span class="k">return</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span
            class="c1"># len(record) ==3: #&quot;primary_id_&amp;_dim:&quot;, primary_id, dim</span>
                        <span class="n">flag</span><span class="p">,</span> <span class="n">primary_id</span><span
            class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">record</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_query_regions</span><span class="p">(</span><span
            class="n">Regions</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span
            class="n">e</span><span class="p">)</span>
                <span class="n">record</span> <span class="o">=</span> <span class="n">records</span><span
            class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="n">records</span><span
            class="o">.</span><span class="fm">__next__</span><span class="p">()</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dims</span><span class="p">,</span> <span class="n">row</span> <span
            class="o">=</span> <span class="n">record</span>
                        <span class="k">yield</span> <span class="nb">list</span><span class="p">(</span><span
            class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_byte2real</span><span
            class="p">(</span><span class="n">row</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">flag</span><span class="p">,</span> <span class="n">primary_id</span><span
            class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">record</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span
            class="n">reference</span><span class="p">))</span>
            <span class="n">ref_reader</span> <span class="o">=</span> <span class="n">Reader</span><span
            class="p">(</span><span class="n">reference</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Dimensions&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">]</span>
                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span
            class="p">[</span><span class="s1">&#39;Columns&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">printout</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span
            class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="c1"># query reference first</span>
                <span class="n">ref_records</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">_query_regions</span><span class="p">(</span><span
            class="n">Regions</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span
            class="n">e</span><span class="p">)</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">primary_id</span><span
            class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span
            class="n">ref_records</span><span class="o">.</span><span class="fm">__next__</span><span
            class="p">()</span>  <span class="c1"># 1st should contain primary_id</span>
                <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">fetchByStartID</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span
            class="n">primary_id</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ref_record</span> <span class="o">=</span> <span class="nb">next</span><span
            class="p">(</span><span class="n">ref_records</span><span class="p">)</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_byte2str</span><span class="p">(</span><span class="nb">next</span><span
            class="p">(</span><span class="n">records</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dims</span><span class="p">,</span> <span class="n">row</span> <span
            class="o">=</span> <span class="n">ref_record</span>
                        <span class="n">rows</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">_byte2str</span><span class="p">(</span><span class="n">row</span><span
            class="p">)</span> <span class="o">+</span> <span class="n">record</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span
            class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span
            class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span
            class="n">dims</span><span class="p">]</span> <span class="o">+</span> <span class="n">rows</span><span
            class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span
            class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
                            <span class="k">return</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span
            class="c1"># len(record) ==3: #&quot;primary_id_&amp;_dim:&quot;, primary_id, dim</span>
                        <span class="n">flag</span><span class="p">,</span> <span class="n">primary_id</span><span
            class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span
            class="n">ref_record</span>  <span class="c1"># next block or next dim</span>
                        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">fetchByStartID</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span
            class="n">primary_id</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span
            class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_records</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">_query_regions</span><span class="p">(</span><span
            class="n">Regions</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span
            class="n">e</span><span class="p">)</span>
                <span class="n">ref_record</span> <span class="o">=</span> <span class="n">ref_records</span><span
            class="o">.</span><span class="fm">__next__</span><span class="p">()</span>  <span class="c1"># 1st should contain primary_id</span>
                <span class="n">flag</span><span class="p">,</span> <span class="n">primary_id</span><span
            class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="n">ref_record</span>
                <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">fetchByStartID</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span
            class="n">primary_id</span><span class="p">)</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">ref_record</span> <span class="o">=</span> <span
            class="n">ref_records</span><span class="o">.</span><span class="fm">__next__</span><span
            class="p">()</span>
                        <span class="n">record</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_byte2str</span><span class="p">(</span><span
            class="n">records</span><span class="o">.</span><span class="fm">__next__</span><span class="p">())</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dims</span><span class="p">,</span> <span class="n">row</span> <span
            class="o">=</span> <span class="n">ref_record</span>
                        <span class="n">rows</span> <span class="o">=</span> <span class="n">ref_reader</span><span
            class="o">.</span><span class="n">_byte2str</span><span class="p">(</span><span class="n">row</span><span
            class="p">)</span> <span class="o">+</span> <span class="n">record</span>
                        <span class="k">yield</span> <span class="nb">list</span><span class="p">(</span><span
            class="n">dims</span><span class="p">)</span> <span class="o">+</span> <span class="n">rows</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>  <span
            class="c1"># len(record) ==3: #&quot;primary_id_&amp;_dim:&quot;, primary_id, dim</span>
                        <span class="n">flag</span><span class="p">,</span> <span class="n">primary_id</span><span
            class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span
            class="n">ref_record</span>  <span class="c1"># next block or next dim</span>
                        <span class="n">records</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">fetchByStartID</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span
            class="n">primary_id</span><span class="p">)</span>
            <span class="n">ref_reader</span><span class="o">.</span><span class="n">close</span><span
            class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_seek_and_read_1record</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span><span class="n">virtual_offset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span
            class="n">virtual_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span
            class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_unit_size</span><span class="p">))</span>

<div class="viewcode-block" id="Reader.tell"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.tell">[docs]</a>    <span
        class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a 64-bit unsigned BGZF virtual offset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span class="ow">and</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span
            class="o">==</span> <span class="nb">len</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">):</span>
            <span class="c1"># Special case where we&#39;re right at the end of a (non empty) block.</span>
            <span class="c1"># For non-maximal blocks could give two possible virtual offsets,</span>
            <span class="c1"># but for a maximal block can&#39;t use _BLOCK_MAX_LEN as the within block</span>
            <span class="c1"># offset. Therefore for consistency, use the next block and a</span>
            <span class="c1"># within block offset of zero.</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_block_start_offset</span> <span class="o">+</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span><span
            class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_block_start_offset</span> <span class="o">&lt;&lt;</span> <span
            class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_within_block_offset</span></div>

<div class="viewcode-block" id="Reader.seek"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.seek">[docs]</a>    <span
        class="k">def</span> <span class="nf">seek</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">virtual_offset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Seek to a 64-bit unsigned BGZF virtual offset.&quot;&quot;&quot;</span>
        <span class="c1"># Do this inline to avoid a function call,</span>
        <span class="c1"># start_offset, within_block = split_virtual_offset(virtual_offset)</span>
        <span class="n">start_offset</span> <span class="o">=</span> <span class="n">virtual_offset</span> <span
            class="o">&gt;&gt;</span> <span class="mi">16</span>
        <span class="n">within_block</span> <span class="o">=</span> <span class="n">virtual_offset</span> <span
            class="o">^</span> <span class="p">(</span><span class="n">start_offset</span> <span
            class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_offset</span> <span class="o">!=</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_block_start_offset</span><span
            class="p">:</span>
            <span class="c1"># Don&#39;t need to load the block if already there</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">(</span><span class="n">start_offset</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start_offset</span> <span class="o">!=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_block_start_offset</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;start_offset not loaded correctly&quot;</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="n">within_block</span> <span class="o">&gt;</span> <span
            class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_buffer</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span
            class="n">within_block</span> <span class="o">==</span> <span class="mi">0</span> <span
            class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">)</span> <span class="o">==</span> <span
            class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Within offset </span><span class="si">%i</span><span class="s2"> but block size only </span><span
            class="si">%i</span><span class="s2">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">within_block</span><span class="p">,</span> <span
            class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_buffer</span><span class="p">))</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span class="o">=</span> <span
            class="n">within_block</span>
        <span class="k">return</span> <span class="n">virtual_offset</span></div>

<div class="viewcode-block" id="Reader.read"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.read">[docs]</a>    <span
        class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span
            class="sd">&quot;&quot;&quot;Read method for the BGZF module.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">b</span><span
            class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="n">size</span> <span class="ow">and</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span><span
            class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span
            class="o">+</span> <span class="n">size</span> <span class="o">&lt;=</span> <span class="nb">len</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span
            class="p">):</span>
                <span class="c1"># This may leave us right at the end of a block</span>
                <span class="c1"># (lazy loading, don&#39;t load the next block unless we have too)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">[</span>
                       <span class="bp">self</span><span class="o">.</span><span
            class="n">_within_block_offset</span><span class="p">:</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_within_block_offset</span> <span class="o">+</span> <span
            class="n">size</span>
                       <span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span
            class="o">+=</span> <span class="n">size</span>
                <span class="c1"># if not data:</span>
                <span class="c1">#     raise ValueError(&quot;Must be at least 1 byte&quot;)</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># need to load the enxt block</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_within_block_offset</span><span class="p">:]</span>
                <span class="n">size</span> <span class="o">-=</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">()</span>  <span class="c1"># will reset offsets and _within_block_offset</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Reader.readline"><a class="viewcode-back"
                                                    href="../../czip.cz.html#czip.cz.Reader.readline">[docs]</a>    <span
        class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read a single line for the BGZF file.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="sa">b</span><span
            class="s2">&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_block_raw_length</span><span
            class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_newline</span><span class="p">,</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span><span
            class="p">)</span>
            <span class="c1"># Three cases to consider,</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span
            class="mi">1</span><span class="p">:</span>
                <span class="c1"># No newline, need to read in more data</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_within_block_offset</span><span class="p">:]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">()</span>  <span class="c1"># will reset offsets</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">+</span> <span
            class="mi">1</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">):</span>
                <span class="c1"># Found new line, but right at end of block (SPECIAL)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_within_block_offset</span><span class="p">:]</span>
                <span class="c1"># Must now load the next block to ensure tell() works</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_block</span><span
            class="p">()</span>  <span class="c1"># will reset offsets</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span
            class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span
            class="s2">&quot;Must be at least 1 byte&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Found new line, not at end of block (easy case, no IO)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_within_block_offset</span><span class="p">:</span> <span
            class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_within_block_offset</span> <span
            class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="c1"># assert data.endswith(self._newline)</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">data</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Reader.close"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.close">[docs]</a>    <span
        class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close BGZF file.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span
            class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_block_start_offset</span> <span
            class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffers</span> <span
            class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Reader.seekable"><a class="viewcode-back"
                                                    href="../../czip.cz.html#czip.cz.Reader.seekable">[docs]</a>    <span
        class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True indicating the BGZF supports random access.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Reader.isatty"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.isatty">[docs]</a>    <span
        class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if connected to a TTY device.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Reader.fileno"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Reader.fileno">[docs]</a>    <span
        class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span
            class="sd">&quot;&quot;&quot;Return integer file descriptor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">fileno</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span
            class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a file operable with WITH statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span
            class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="w">        </span><span
            class="sd">&quot;&quot;&quot;Close a file with WITH statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="extract"><a class="viewcode-back"
                                            href="../../czip.cz.html#czip.cz.extract">[docs]</a><span
        class="k">def</span> <span class="nf">extract</span><span class="p">(</span><span class="nb">input</span><span
        class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span
        class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ssi</span><span
        class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chunksize</span><span
        class="o">=</span><span class="mi">5000</span><span class="p">):</span>
    <span class="n">ssi_reader</span> <span class="o">=</span> <span class="n">Reader</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span
            class="p">(</span><span class="n">ssi</span><span class="p">)))</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span
            class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span
            class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span
            class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span
            class="nb">input</span><span class="p">)))</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span
            class="n">outfile</span><span class="p">,</span> <span class="n">Formats</span><span class="o">=</span><span
            class="n">reader</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Formats&#39;</span><span class="p">],</span>
                    <span class="n">Columns</span><span class="o">=</span><span class="n">reader</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Columns&#39;</span><span class="p">],</span>
                    <span class="n">Dimensions</span><span class="o">=</span><span class="n">reader</span><span
            class="o">.</span><span class="n">header</span><span class="p">[</span><span
            class="s1">&#39;Dimensions&#39;</span><span class="p">],</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">ssi</span><span
            class="p">)</span>
    <span class="c1"># dtfuncs = get_dtfuncs(writer.Formats)</span>
    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">reader</span><span
            class="o">.</span><span class="n">dim2chunk_start</span><span class="o">.</span><span
            class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
        <span class="n">IDs</span> <span class="o">=</span> <span class="n">ssi_reader</span><span
            class="o">.</span><span class="n">get_ids_from_ssi</span><span class="p">(</span><span
            class="n">dim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span
            class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span
            class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Only support 1D ssi now!&quot;</span><span
            class="p">)</span>
        <span class="n">records</span> <span class="o">=</span> <span class="n">reader</span><span
            class="o">.</span><span class="n">_getRecordsByIds</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="n">IDs</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span
            class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span
            class="n">records</span><span class="p">:</span>  <span class="c1"># unpacked bytes</span>
            <span class="n">data</span> <span class="o">+=</span> <span class="n">record</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span
            class="n">chunksize</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">write_chunk</span><span
            class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span
            class="p">)</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">i</span> <span
            class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span
            class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span
            class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write_chunk</span><span
            class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span
            class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">ssi_reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="Writer"><a class="viewcode-back"
                                           href="../../czip.cz.html#czip.cz.Writer">[docs]</a><span
        class="k">class</span> <span class="nc">Writer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="n">Output</span><span class="o">=</span><span class="kc">None</span><span
            class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wb&quot;</span><span
            class="p">,</span> <span class="n">Formats</span><span class="o">=</span><span class="p">[</span><span
            class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span
            class="p">],</span>
                 <span class="n">Columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mc&#39;</span><span
            class="p">,</span> <span class="s1">&#39;cov&#39;</span><span class="p">],</span> <span
            class="n">Dimensions</span><span class="o">=</span><span class="p">[</span><span
            class="s1">&#39;chrom&#39;</span><span class="p">],</span> <span class="n">fileobj</span><span
            class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span
            class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">6</span><span
            class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span
            class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        czip .cz writer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Output : path or None</span>
<span class="sd">            if None (default) bytes stream would be written to stdout.</span>
<span class="sd">        mode : str</span>
<span class="sd">            &#39;wb&#39;, &#39;ab&#39;</span>
<span class="sd">        Formats : list</span>
<span class="sd">            format for each column, see https://docs.python.org/3/library/struct.html#format-characters for detail format.</span>
<span class="sd">        Columns : list</span>
<span class="sd">            columns names, length should be the same as Formats.</span>
<span class="sd">        Dimensions : list</span>
<span class="sd">            Dimensions to be included for each chunk, for example, if you would like</span>
<span class="sd">            to include sampleID and chromosomes as dimension title, then set</span>
<span class="sd">            Dimsnsion=[&#39;sampleID&#39;,&#39;chrom&#39;], then give each chunk a dims,</span>
<span class="sd">            for example, dims for chunk1 is [&#39;cell1&#39;,&#39;chr1&#39;], dims for chunk2 is</span>
<span class="sd">            [&#39;cell1&#39;,&#39;chr2&#39;], [&#39;cell2&#39;,&#39;chr1&#39;],....[&#39;celln&#39;,&#39;chr22&#39;]...</span>
<span class="sd">        fileobj : object</span>
<span class="sd">            an openned file object</span>
<span class="sd">        message : str</span>
<span class="sd">            a message to be included in the header, a genome assemble version</span>
<span class="sd">            is highly recommended to be set as message.</span>
<span class="sd">        level : int</span>
<span class="sd">            compress level (default is 6)</span>
<span class="sd">        verbose : int</span>
<span class="sd">            whether to print debug information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Output</span> <span class="ow">and</span> <span
            class="n">fileobj</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Supply either Output or fileobj, not both&quot;</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="n">fileobj</span><span class="p">:</span>  <span class="c1"># write to an existed openned file object</span>
            <span class="k">if</span> <span class="n">fileobj</span><span class="o">.</span><span
            class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span
            class="o">!=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fileobj not opened in binary mode&quot;</span><span
            class="p">)</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">fileobj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Output</span> <span
            class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># write output to a file</span>
                <span class="k">if</span> <span class="s2">&quot;w&quot;</span> <span class="ow">not</span> <span
            class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span
            class="p">()</span> <span class="ow">and</span> <span class="s2">&quot;a&quot;</span> <span
            class="ow">not</span> <span class="ow">in</span> <span class="n">mode</span><span class="o">.</span><span
            class="n">lower</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;Must use write or append mode&quot;</span><span class="p">)</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">_open</span><span
            class="p">(</span><span class="n">Output</span><span class="p">,</span> <span class="n">mode</span><span
            class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Output</span><span
            class="o">=</span><span class="n">Output</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># write to stdout buffer</span>
                <span class="n">handle</span> <span class="o">=</span> <span class="n">sys</span><span
            class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span> <span
            class="o">=</span> <span class="n">handle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span
            class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_start_offset</span> <span
            class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span> <span class="o">=</span> <span
            class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Formats</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span
            class="ow">and</span> <span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span
            class="ow">in</span> <span class="n">Formats</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Formats</span> <span class="o">=</span> <span
            class="p">[</span><span class="n">Formats</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Formats</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Formats</span> <span class="o">=</span> <span
            class="n">Formats</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span
            class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Formats</span> <span class="o">=</span> <span
            class="nb">list</span><span class="p">(</span><span class="n">Formats</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span
            class="n">level</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Columns</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Columns</span> <span class="o">=</span> <span
            class="n">Columns</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span
            class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Columns</span> <span class="o">=</span> <span
            class="nb">list</span><span class="p">(</span><span class="n">Columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Dimensions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dimensions</span> <span
            class="o">=</span> <span class="n">Dimensions</span><span class="o">.</span><span
            class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Dimensions</span> <span
            class="o">=</span> <span class="nb">list</span><span class="p">(</span><span
            class="n">Dimensions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_magic_size</span> <span class="o">=</span> <span
            class="nb">len</span><span class="p">(</span><span class="n">_bcz_magic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span
            class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span
            class="o">=</span> <span class="n">message</span>
        <span class="c1"># if self.verbose &gt; 0:</span>
        <span class="c1">#     print(self.Formats, self.Columns, self.Dimensions)</span>
        <span class="c1">#     print(type(self.Formats), type(self.Columns), type(self.Dimensions))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_header</span><span class="p">()</span>

<div class="viewcode-block" id="Writer.write_header"><a class="viewcode-back"
                                                        href="../../czip.cz.html#czip.cz.Writer.write_header">[docs]</a>    <span
        class="k">def</span> <span class="nf">write_header</span><span class="p">(</span><span
        class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_handle</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_magic_size</span><span
            class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">_bcz_magic</span><span
            class="p">))</span>  <span class="c1"># 5 bytes</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;f&quot;</span><span class="p">,</span> <span class="n">_version</span><span class="p">))</span>  <span
            class="c1"># 4 bytes, float</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span
            class="p">))</span>  <span class="c1"># 8 bytes, total size, including magic.</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="nb">len</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span
            class="p">)))</span>  <span class="c1"># length of each format, 1 byte</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">message</span><span class="p">)</span><span class="si">}</span><span
            class="s2">s&quot;</span><span class="p">,</span>
                            <span class="nb">bytes</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">message</span><span class="p">,</span> <span
            class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="nb">len</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Formats</span><span
            class="p">)))</span>  <span class="c1"># 1byte, ncols</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">Columns</span><span class="p">)</span> <span
            class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">Formats</span><span class="p">)</span>
        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">Formats</span><span class="p">:</span>
            <span class="n">format_len</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="nb">format</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="n">format_len</span><span
            class="p">))</span>  <span class="c1"># length of each format, 1 byte</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="n">format_len</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span
            class="nb">bytes</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span
            class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">Columns</span><span class="p">:</span>
            <span class="n">name_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">name</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="n">name_len</span><span class="p">))</span>  <span
            class="c1"># length of each name, 1 byte</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="n">name_len</span><span class="si">}</span><span class="s2">s&quot;</span><span
            class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">name</span><span
            class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_dim_offset</span><span class="o">=</span><span
            class="n">f</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="c1">#when a new dim is added, go back here and rewrite the n_dim (1byte)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="nb">len</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dimensions</span><span
            class="p">)))</span>  <span class="c1"># 1byte</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">Dimensions</span><span class="p">:</span>
            <span class="n">dname_len</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">dim</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="n">dname_len</span><span class="p">))</span>  <span
            class="c1"># length of each name, 1 byte</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="n">dname_len</span><span class="si">}</span><span class="s2">s&quot;</span><span
            class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">dim</span><span
            class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
        <span class="c1"># when multiple .cz are cat into one .cz and a new dimension is added,</span>
        <span class="c1"># such as sampleID, seek to this position (_header_size) and write another</span>
        <span class="c1"># two element: new_dname_len (B) and new_dim, then go to</span>
        <span class="c1"># _n_dim_offset,rewrite the n_dim (n_dim = n_dim + 1) and</span>
        <span class="c1"># self.Dimensions.append(new_dim)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_header_size</span><span
            class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">tell</span><span
            class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmts</span> <span class="o">=</span> <span
            class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span
            class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">Formats</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span> <span
            class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span
            class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write_block</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">):</span>
        <span class="c1"># if len(block) &gt; _BLOCK_MAX_LEN:  # 65536 = 1 &lt;&lt; 16 = 2**16</span>
        <span class="c1">#     raise ValueError(f&quot;{len(block)} Block length &gt; {_BLOCK_MAX_LEN}&quot;)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">zlib</span><span class="o">.</span><span
            class="n">compressobj</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">level</span><span
            class="p">,</span> <span class="n">zlib</span><span class="o">.</span><span class="n">DEFLATED</span><span
            class="p">,</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span
            class="n">zlib</span><span class="o">.</span><span class="n">DEF_MEM_LEVEL</span><span
            class="p">,</span> <span class="mi">0</span>
        <span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		deflate_compress = zlib.compressobj(9, zlib.DEFLATED, -zlib.MAX_WBITS)</span>
<span class="sd">		zlib_compress = zlib.compressobj(9, zlib.DEFLATED, zlib.MAX_WBITS)</span>
<span class="sd">		gzip_compress = zlib.compressobj(9, zlib.DEFLATED, zlib.MAX_WBITS | 16)</span>
<span class="sd">		&quot;&quot;&quot;</span>
        <span class="n">compressed</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span
            class="n">compress</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span
            class="o">+</span> <span class="n">c</span><span class="o">.</span><span class="n">flush</span><span
            class="p">()</span>
        <span class="k">del</span> <span class="n">c</span>
        <span class="c1"># if len(compressed) &gt; _BLOCK_MAX_LEN:</span>
        <span class="c1">#     raise RuntimeError(</span>
        <span class="c1">#         &quot;Didn&#39;t compress enough, try less data in this block&quot;</span>
        <span class="c1">#     )</span>
        <span class="n">bsize</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span
            class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;H&quot;</span><span
            class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">compressed</span><span
            class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c1"># block size: magic (2 btyes) + block_size (2bytes) + compressed data +</span>
        <span class="c1"># block_data_len (2 bytes)</span>
        <span class="n">data_len</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="n">uncompressed_length</span> <span class="o">=</span> <span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;H&quot;</span><span class="p">,</span> <span class="n">data_len</span><span
            class="p">)</span>  <span class="c1"># 2 bytes</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_block_magic</span> <span
            class="o">+</span> <span class="n">bsize</span> <span class="o">+</span> <span
            class="n">compressed</span> <span class="o">+</span> <span class="n">uncompressed_length</span>
        <span class="n">block_start_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">tell</span><span
            class="p">()</span>
        <span class="n">within_block_offset</span> <span class="o">=</span> <span class="nb">int</span><span
            class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_data_len</span> <span
            class="o">/</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_unit_size</span><span class="p">)</span> <span class="o">*</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_unit_size</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_data_len</span><span class="p">)</span>
        <span class="n">virtual_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_start_offset</span> <span
            class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span
            class="n">within_block_offset</span>
        <span class="bp">self</span><span class="o">.</span><span
            class="n">_block_1st_record_virtual_offsets</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">virtual_offset</span><span class="p">)</span>
        <span class="c1"># _block_offsets are real position on disk, not a virtual offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># how many bytes (uncompressed) have been writen.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_data_len</span> <span
            class="o">+=</span> <span class="n">data_len</span>

    <span class="k">def</span> <span class="nf">_write_chunk_tail</span><span class="p">(</span><span
            class="bp">self</span><span class="p">):</span>
        <span class="c1"># tail: chunk_data_len (Q,8bytes) + n_blocks (Q, 8bytes)</span>
        <span class="c1"># + list of block start offsets (n_blocks * 8 bytes)</span>
        <span class="c1"># + List of dimensions ()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span
            class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;Q&quot;</span><span
            class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_data_len</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span
            class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;Q&quot;</span><span
            class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_block_1st_record_virtual_offsets</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">block_offset</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_block_1st_record_virtual_offsets</span><span
            class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;Q&quot;</span><span class="p">,</span> <span class="n">block_offset</span><span
            class="p">))</span>
        <span class="c1"># write list of dims</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span><span class="p">:</span>
            <span class="n">dim_len</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">dim</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="n">dim_len</span><span
            class="p">))</span>  <span class="c1"># length of each dim, 1 byte</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">dim_len</span><span class="si">}</span><span
            class="s2">s&quot;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span
            class="p">)))</span>

    <span class="k">def</span> <span class="nf">_chunk_finished</span><span class="p">(</span><span
            class="bp">self</span><span class="p">):</span>
        <span class="c1"># current position is the end of chunk.</span>
        <span class="n">cur_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">tell</span><span
            class="p">()</span>  <span class="c1"># before chunk tail, not a virtual offset</span>
        <span class="c1"># go back and write the total chunk size (tail not included)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_start_offset</span> <span class="o">+</span> <span class="mi">2</span><span
            class="p">)</span>  <span class="c1"># 2 bytes for magic</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">cur_offset</span> <span
            class="o">-</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_start_offset</span>
        <span class="c1"># chunk_size including the chunk_size itself, but not including chunk tail.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span
            class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;Q&quot;</span><span
            class="p">,</span> <span class="n">chunk_size</span><span class="p">))</span>
        <span class="c1"># go back the current position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">seek</span><span class="p">(</span><span class="n">cur_offset</span><span
            class="p">)</span>  <span class="c1"># not a virtual offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_chunk_tail</span><span
            class="p">()</span>

<div class="viewcode-block" id="Writer.write_chunk"><a class="viewcode-back"
                                                       href="../../czip.cz.html#czip.cz.Writer.write_chunk">[docs]</a>    <span
        class="k">def</span> <span class="nf">write_chunk</span><span class="p">(</span><span
        class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span
        class="n">dims</span><span class="p">):</span>  <span class="c1"># dims is a list.</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data into one chunk with dimension name (such as [&#39;cell1&#39;,&#39;chr1&#39;])</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : bytes</span>
<span class="sd">            In general data should be bytes.</span>
<span class="sd">        dims : list or tuple</span>
<span class="sd">            dimensions to be written to chunk, length of dims should be the same</span>
<span class="sd">            as Dimensions given to Writer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># assert len(dims)==len(self.Dimensions)</span>
        <span class="c1"># if isinstance(data, str):</span>
        <span class="c1">#     data = data.encode(&quot;latin-1&quot;)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span> <span
            class="o">!=</span> <span class="n">dims</span><span class="p">:</span>
            <span class="c1"># the first chunk or another new chunk</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_chunk_dims</span> <span class="ow">is</span> <span class="ow">not</span> <span
            class="kc">None</span><span class="p">:</span>
                <span class="c1"># this is another new chunk, current position is the end of chunk.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span
            class="p">()</span>  <span class="c1"># finish_chunk in flush</span>
            <span class="c1"># else: #the first chunk, no chunk was writen previously.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_dims</span> <span
            class="o">=</span> <span class="n">dims</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_start_offset</span> <span
            class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">tell</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span
            class="n">_chunk_magic</span><span class="p">)</span>
            <span class="c1"># chunk total size place holder: 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;Q&quot;</span><span class="p">,</span> <span class="mi">0</span><span
            class="p">))</span>  <span class="c1"># 8 bytes; including this chunk_size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_data_len</span> <span
            class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_block_1st_record_virtual_offsets</span> <span
            class="o">=</span> <span class="p">[]</span>
            <span class="c1"># if self.verbose &gt; 0:</span>
            <span class="c1">#     print(&quot;Writing chunk with dims: &quot;, self._chunk_dims)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">)</span> <span class="o">+</span> <span
            class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span
            class="o">&lt;</span> <span class="n">_BLOCK_MAX_LEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">+=</span> <span
            class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">+=</span> <span
            class="n">data</span>
            <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span
            class="n">_BLOCK_MAX_LEN</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_block</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span
            class="p">[:</span><span class="n">_BLOCK_MAX_LEN</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span
            class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span
            class="p">[</span><span class="n">_BLOCK_MAX_LEN</span><span class="p">:]</span></div>

    <span class="k">def</span> <span class="nf">_parse_input_no_ref</span><span class="p">(</span><span
            class="bp">self</span><span class="p">,</span> <span class="n">input_handle</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">input_handle</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span
            class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># usecols and dim_cols should be in the columns of this dataframe.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">chunksize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span class="n">df1</span> <span
            class="ow">in</span> <span class="n">input_handle</span><span class="o">.</span><span
            class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">dim_cols</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span
            class="n">usecols</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span
            class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">list</span><span
            class="p">):</span>
                        <span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span
            class="n">dim</span><span class="p">]</span>
                    <span class="k">yield</span> <span class="n">df1</span><span class="p">,</span> <span
            class="n">dim</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">input_handle</span><span class="o">.</span><span class="n">shape</span><span
            class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span
            class="mi">0</span><span class="p">:</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="n">input_handle</span><span
            class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="bp">self</span><span
            class="o">.</span><span class="n">chunksize</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">dim</span><span class="p">,</span> <span
            class="n">df1</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span
            class="n">groupby</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">dim_cols</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span
            class="n">usecols</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span
            class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">list</span><span
            class="p">):</span>
                            <span class="n">dim</span> <span class="o">=</span> <span class="p">[</span><span class="n">dim</span><span
            class="p">]</span>
                        <span class="k">yield</span> <span class="n">df1</span><span class="p">,</span> <span class="n">dim</span>
                    <span class="n">input_handle</span> <span class="o">=</span> <span
            class="n">input_handle</span><span class="o">.</span><span class="n">iloc</span><span
            class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chunksize</span><span
            class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">_input_parser</span><span class="p">(</span><span
            class="n">input_handle</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">Formats</span><span class="p">,</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">sep</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span
            class="n">usecols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">dim_cols</span><span class="p">,</span>
                                     <span class="bp">self</span><span class="o">.</span><span
            class="n">chunksize</span><span class="p">)</span>

<div class="viewcode-block" id="Writer.tocz"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Writer.tocz">[docs]</a>    <span
        class="k">def</span> <span class="nf">tocz</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">Input</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span
        class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">dim_cols</span><span
        class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
             <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span
            class="n">chunksize</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span
            class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span
            class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pack dataframe, stdin or a file path into .cz file with or without reference</span>
<span class="sd">        coordinates file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Input : input</span>
<span class="sd">            list, tuple, np.ndarray or dataframe, stdin (Input is None, &quot;stdin&quot; or &quot;-&quot;),</span>
<span class="sd">            or a file path (need to specify sep,header and skiprows).</span>
<span class="sd">        usecols : list</span>
<span class="sd">            usecols is the index of columns to be packed into .cz Columns.</span>
<span class="sd">        dim_cols : list</span>
<span class="sd">            index of columns to be set as Dimensions of Writer, such as chrom</span>
<span class="sd">            columns.</span>
<span class="sd">        sep : str</span>
<span class="sd">            defauls is &quot;\t&quot;, used as separator for the input file path.</span>
<span class="sd">        chunksize : int</span>
<span class="sd">            Chunk Input dataframe of file path.</span>
<span class="sd">        header : bool</span>
<span class="sd">            whether the input file path contain header.</span>
<span class="sd">        skiprows : int</span>
<span class="sd">            number of rows to skip for input file path.</span>
<span class="sd">        pr: int or str</span>
<span class="sd">            If reference was given, use the `pr` column as coordinates, which</span>
<span class="sd">            would be used to match the `p` column in the Input file or df.</span>
<span class="sd">            If Input is a file path, then `pr` should be int, if Input is a dataframe with</span>
<span class="sd">            custom columns names, then `pr` should be string matching the column</span>
<span class="sd">            name in dataframe.</span>
<span class="sd">        p: int or str</span>
<span class="sd">            Similar as `pr`, `p` is the column in Input to match the coordinate in</span>
<span class="sd">            the reference file. When Input is a file path or stdin, p should be int,</span>
<span class="sd">            but if Input is a dataframe, p should be the name appear in the dataframe</span>
<span class="sd">            header columns.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span
            class="n">sep</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Input</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span
            class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">usecols</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">usecols</span> <span
            class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span
            class="n">usecols</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">usecols</span><span
            class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">usecols</span> <span
            class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span
            class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span
            class="ow">in</span> <span class="n">usecols</span><span class="o">.</span><span class="n">split</span><span
            class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">usecols</span> <span
            class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span
            class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span
            class="ow">in</span> <span class="n">usecols</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">dim_cols</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dim_cols</span> <span
            class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span
            class="n">dim_cols</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim_cols</span><span
            class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dim_cols</span> <span
            class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span
            class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span
            class="ow">in</span> <span class="n">dim_cols</span><span class="o">.</span><span
            class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dim_cols</span> <span
            class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span
            class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span
            class="ow">in</span> <span class="n">dim_cols</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">usecols</span> <span class="o">=</span> <span
            class="n">usecols</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dim_cols</span> <span class="o">=</span> <span
            class="n">dim_cols</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">usecols</span><span class="p">)</span> <span
            class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">Formats</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">dim_cols</span><span class="p">)</span> <span
            class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">Dimensions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunksize</span> <span
            class="o">=</span> <span class="n">chunksize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span
            class="n">header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skiprows</span> <span
            class="o">=</span> <span class="n">skiprows</span>
        <span class="c1"># if self.verbose &gt; 0:</span>
        <span class="c1">#     print(&quot;Input: &quot;, type(Input), Input)</span>

        <span class="k">if</span> <span class="n">Input</span> <span class="ow">is</span> <span
            class="kc">None</span> <span class="ow">or</span> <span class="n">Input</span> <span
            class="o">==</span> <span class="s1">&#39;stdin&#39;</span><span class="p">:</span>
            <span class="n">data_generator</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_parse_input_no_ref</span><span class="p">(</span><span
            class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">input_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span
            class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span
            class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span
            class="n">expanduser</span><span class="p">(</span><span class="n">Input</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span
            class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span
            class="n">input_path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown format for Input&quot;</span><span
            class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">exists</span><span class="p">(</span><span
            class="n">input_path</span> <span class="o">+</span> <span class="s1">&#39;.tbi&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please use bed2cz command to convert input to .cz.&quot;</span><span
            class="p">)</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_generator</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_parse_input_no_ref</span><span class="p">(</span><span class="n">input_path</span><span
            class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Input</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span
            class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span
            class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="n">Input</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span
            class="n">DataFrame</span><span class="p">(</span><span class="n">Input</span><span class="p">)</span>
            <span class="n">data_generator</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_parse_input_no_ref</span><span class="p">(</span><span
            class="n">Input</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Input</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span
            class="n">DataFrame</span><span class="p">):</span>
            <span class="n">data_generator</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_parse_input_no_ref</span><span class="p">(</span><span
            class="n">Input</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span
            class="sa">f</span><span class="s2">&quot;Unknow input type&quot;</span><span class="p">)</span>

        <span class="c1"># if self.verbose &gt; 0:</span>
        <span class="c1">#     print(self.usecols, self.dim_cols)</span>
        <span class="c1">#     print(type(self.usecols), type(self.dim_cols))</span>
        <span class="k">for</span> <span class="n">df</span><span class="p">,</span> <span class="n">dim</span> <span
            class="ow">in</span> <span class="n">data_generator</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span
            class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span
            class="p">:</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span
            class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span
            class="bp">self</span><span class="o">.</span><span class="n">fmts</span><span class="si">}</span><span
            class="s2">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">x</span><span
            class="o">.</span><span class="n">tolist</span><span class="p">()),</span>
                            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span
            class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_chunk</span><span
            class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span
            class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Writer.create_new_dim"><a class="viewcode-back"
                                                          href="../../czip.cz.html#czip.cz.Writer.create_new_dim">[docs]</a>    <span
        class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_new_dim</span><span class="p">(</span><span
            class="n">basename</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">basename</span><span class="o">.</span><span class="n">endswith</span><span
            class="p">(</span><span class="s1">&#39;.cz&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">basename</span><span class="p">[:</span><span
            class="o">-</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">basename</span></div>

<div class="viewcode-block" id="Writer.catcz"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Writer.catcz">[docs]</a>    <span
        class="k">def</span> <span class="nf">catcz</span><span class="p">(</span><span class="bp">self</span><span
        class="p">,</span> <span class="n">Input</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">dim_order</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span> <span class="n">add_dim</span><span class="o">=</span><span class="kc">False</span><span
        class="p">,</span>
              <span class="n">title</span><span class="o">=</span><span class="s2">&quot;filename&quot;</span><span
            class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Cat multiple .cz files into one .cz file.</span>

<span class="sd">		Parameters</span>
<span class="sd">		----------</span>
<span class="sd">		Input : str or list</span>
<span class="sd">			Either a str (including *, as input for glob, should be inside the\</span>
<span class="sd">			double quotation marks if using fire) or a list.</span>
<span class="sd">		dim_order : None, list or path</span>
<span class="sd">			If dim_order=None, Input will be sorted using python sorted.</span>
<span class="sd">			If dim_order is a list, tuple or array of basename.rstrip(.cz), sorted as dim_order.</span>
<span class="sd">			If dim_order is a file path (for example, chrom size path to dim_order chroms</span>
<span class="sd">			or only use selected chroms) will be sorted as</span>
<span class="sd">			the 1st column of the input file path (without header, tab-separated).</span>
<span class="sd">			default is None</span>
<span class="sd">        add_dim: bool or function</span>
<span class="sd">            whether to add .cz file names as an new dimension to the merged</span>
<span class="sd">            .cz file. For example, we have multiple .cz files for many cells, in</span>
<span class="sd">            each .cz file, the dimensions are [&#39;chrom&#39;], after merged, we would</span>
<span class="sd">            like to add file name of .cz as a new dimension [&#39;cell_id&#39;]. In this case,</span>
<span class="sd">            the dimensions in the merged header would be [&quot;chrom&quot;,&quot;cell_id&quot;], and</span>
<span class="sd">            in each chunk, in addition to the previous dim [&#39;chr1&#39;] or [&#39;chr22&#39;].., a</span>
<span class="sd">            new dim would also be append to the previous dim, like [&#39;chr1&#39;,&#39;cell_1&#39;],</span>
<span class="sd">            [&#39;chr22&#39;,&#39;cell_100&#39;].</span>
<span class="sd">            However, if add_dim is a function, the input to this function is the .cz</span>
<span class="sd">            file basename, the returned value from this funcion would be used</span>
<span class="sd">            as new dim and added into the chunk_dims. The default function to</span>
<span class="sd">            convert filename to dim name is self.create_new_dim.</span>
<span class="sd">        title: str</span>
<span class="sd">            if add_dim is True or a python function, title would be append to</span>
<span class="sd">            the header[&#39;Dimensions&#39;] of the merged .cz file&#39;s header. If the title of</span>
<span class="sd">            new dimension had already given in Writer Dimensions,</span>
<span class="sd">            title can be None, otherwise, title should be provided.</span>

<span class="sd">		Returns</span>
<span class="sd">		-------</span>

<span class="sd">		&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Input</span><span
            class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span
            class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">Input</span><span
            class="p">:</span>
            <span class="n">Input</span> <span class="o">=</span> <span class="n">glob</span><span
            class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">Input</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span
            class="n">Input</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input should be either a list of a string including *.&quot;</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="n">dim_order</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
            <span class="n">Input</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span
            class="n">Input</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># creating a dict, keys are file base name, value are full path</span>
            <span class="n">D</span> <span class="o">=</span> <span class="p">{</span><span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span
            class="p">(</span><span class="n">inp</span><span class="p">)[:</span><span class="o">-</span><span
            class="mi">3</span><span class="p">]:</span> <span class="n">inp</span> <span class="k">for</span> <span
            class="n">inp</span> <span class="ow">in</span> <span class="n">Input</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span
            class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim_order</span><span
            class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="c1"># read each file from path containing file basename</span>
                <span class="n">dim_order</span> <span class="o">=</span> <span class="n">pd</span><span
            class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span
            class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span
            class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span
            class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span
            class="n">dim_order</span><span class="p">)),</span>
                                    <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span
            class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">header</span><span
            class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">usecols</span><span
            class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span
            class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim_order</span><span
            class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span
            class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span
            class="n">ndarray</span><span class="p">)):</span>  <span class="c1"># dim_order is a list</span>
                <span class="c1"># Input=[str(i)+&#39;.cz&#39; for i in dim_order]</span>
                <span class="n">Input</span> <span class="o">=</span> <span class="p">[</span><span
            class="n">D</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span
            class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span
            class="ow">in</span> <span class="n">dim_order</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;input of dim_order is not corrected !&quot;</span><span
            class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">Input</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_dim_creator</span> <span
            class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">add_dim</span><span class="o">!=</span><span
            class="kc">False</span><span class="p">:</span> <span class="c1"># add filename as another dimension.</span>
            <span class="k">if</span> <span class="n">add_dim</span><span class="o">==</span><span
            class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_dim_creator</span><span
            class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_new_dim</span>
            <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span
            class="n">add_dim</span><span class="p">):</span> <span class="c1">#is a function</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_dim_creator</span> <span
            class="o">=</span> <span class="n">add_dim</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;add_dim should either be True,False or a function&quot;</span><span
            class="p">)</span>

        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span
            class="n">Input</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span
            class="n">file_path</span><span class="p">)</span>
            <span class="c1"># data_size = reader.header[&#39;total_size&#39;] - reader.header[&#39;header_size&#39;]</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span
            class="n">get_chunks</span><span class="p">()</span>
            <span class="p">(</span><span class="n">start_offset</span><span class="p">,</span> <span class="n">chunk_size</span><span
            class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">data_len</span><span
            class="p">,</span>
             <span class="n">end_offset</span><span class="p">,</span> <span class="n">nblocks</span><span
            class="p">,</span> <span class="n">b1str_virtual_offsets</span><span class="p">)</span> <span
            class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">chunks</span><span
            class="p">)</span>
            <span class="c1"># check whether new dim has already been added to header</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">new_dim_creator</span> <span class="ow">is</span> <span
            class="kc">None</span><span class="p">:</span>
                <span class="n">new_dim</span> <span class="o">=</span> <span class="p">[</span><span
            class="bp">self</span><span class="o">.</span><span class="n">new_dim_creator</span><span class="p">(</span><span
            class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span
            class="n">basename</span><span class="p">(</span><span class="n">file_path</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_dim</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span
            class="n">dims</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span
            class="n">new_dim</span><span class="p">))</span> <span class="o">&gt;</span> <span
            class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">Dimensions</span><span class="p">):</span>
                <span class="c1"># new_dim title should be also added to header Dimensions</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Dimensions</span> <span
            class="o">=</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">Dimensions</span> <span class="o">+</span> <span class="p">[</span><span
            class="n">title</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_n_dim_offset</span><span class="p">)</span>
                <span class="c1"># when a new dim is added, go back here and rewrite the n_dim (1byte)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="nb">len</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Dimensions</span><span
            class="p">)))</span>  <span class="c1"># 1byte</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span
            class="o">.</span><span class="n">_header_size</span><span class="p">)</span>
                <span class="c1"># write new dim to the end of header</span>
                <span class="n">dname_len</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="n">dname_len</span><span class="p">))</span>  <span
            class="c1"># length of each name, 1 byte</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">dname_len</span><span
            class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span
            class="nb">bytes</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span
            class="s1">&#39;utf-8&#39;</span><span class="p">)))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_header_size</span> <span class="o">=</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">tell</span><span class="p">()</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1"># process each file (chunk)</span>
                <span class="n">reader</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">seek</span><span class="p">(</span><span
            class="n">start_offset</span><span class="p">)</span>  <span class="c1"># chunk start offset</span>
                <span class="c1"># write the enrire chunk</span>
                <span class="n">new_chunk_start_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">tell</span><span
            class="p">()</span>
                <span class="n">delta_offset</span> <span class="o">=</span> <span
            class="n">new_chunk_start_offset</span> <span class="o">-</span> <span class="n">start_offset</span>
                <span class="c1"># self._handle.write(reader._handle.read(end_offset - start_offset))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reader</span><span
            class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">read</span><span
            class="p">(</span><span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">16</span><span
            class="p">))</span>
                <span class="c1"># modify the chunk_black_1st_record_virtual_offsets</span>
                <span class="n">new_block_1st_record_vof</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">b1str_virtual_offsets</span><span
            class="p">:</span>
                    <span class="n">block_offset</span><span class="p">,</span> <span
            class="n">within_block_offset</span> <span class="o">=</span> <span
            class="n">split_virtual_offset</span><span class="p">(</span><span class="n">offset</span><span
            class="p">)</span>
                    <span class="n">new_block_offset</span> <span class="o">=</span> <span class="n">delta_offset</span> <span
            class="o">+</span> <span class="n">block_offset</span>
                    <span class="n">new_1st_rd_vof</span> <span class="o">=</span> <span
            class="n">make_virtual_offset</span><span class="p">(</span><span class="n">new_block_offset</span><span
            class="p">,</span>
                                                         <span class="n">within_block_offset</span><span
            class="p">)</span>
                    <span class="n">new_block_1st_record_vof</span><span class="o">.</span><span class="n">append</span><span
            class="p">(</span><span class="n">new_1st_rd_vof</span><span class="p">)</span>
                <span class="c1"># write new_block_1st_record_vof</span>
                <span class="k">for</span> <span class="n">block_offset</span> <span class="ow">in</span> <span
            class="n">new_block_1st_record_vof</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;Q&quot;</span><span class="p">,</span> <span class="n">block_offset</span><span
            class="p">))</span>
                <span class="c1"># rewrite the new dim onto the tail of chunk</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span
            class="n">dims</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span
            class="n">new_dim</span><span class="p">):</span>
                    <span class="n">dim_len</span> <span class="o">=</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">dim</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span
            class="s2">&quot;&lt;B&quot;</span><span class="p">,</span> <span class="n">dim_len</span><span
            class="p">))</span>  <span class="c1"># length of each dim, 1 byte</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">struct</span><span
            class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="sa">f</span><span
            class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">dim_len</span><span class="si">}</span><span
            class="s2">s&quot;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span
            class="n">dim</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span
            class="p">)))</span>
                    <span class="c1"># print(dim_len,dim)</span>
                <span class="c1"># read next chunk</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">start_offset</span><span class="p">,</span> <span class="n">chunk_size</span><span
            class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">data_len</span><span
            class="p">,</span>
                     <span class="n">end_offset</span><span class="p">,</span> <span class="n">nblocks</span><span
            class="p">,</span> <span class="n">b1str_virtual_offsets</span><span class="p">)</span> <span
            class="o">=</span> <span class="n">chunks</span><span class="o">.</span><span
            class="fm">__next__</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">reader</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_total_size_eof_close</span><span
            class="p">()</span></div>

<div class="viewcode-block" id="Writer.flush"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Writer.flush">[docs]</a>    <span
        class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush data explicitally.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">)</span> <span
            class="o">&gt;=</span> <span class="n">_BLOCK_MAX_LEN</span><span class="p">:</span>
            <span class="c1"># I don&#39;t think this is going to happen</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_block</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span
            class="p">[:</span><span class="n">_BLOCK_MAX_LEN</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span class="o">=</span> <span
            class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">[</span><span
            class="n">_BLOCK_MAX_LEN</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_block</span><span
            class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span
            class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_finished</span><span
            class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_buffer</span> <span
            class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">flush</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_write_total_size_eof_close</span><span class="p">(</span><span
            class="bp">self</span><span class="p">):</span>
        <span class="n">cur_offset</span> <span class="o">=</span> <span class="bp">self</span><span
            class="o">.</span><span class="n">_handle</span><span class="o">.</span><span class="n">tell</span><span
            class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span
            class="n">_magic_size</span> <span class="o">+</span> <span class="mi">4</span><span
            class="p">)</span>  <span class="c1"># magic and version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span
            class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;Q&quot;</span><span
            class="p">,</span> <span class="n">cur_offset</span><span class="p">))</span>  <span class="c1"># real offset.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">seek</span><span class="p">(</span><span class="n">cur_offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">write</span><span class="p">(</span><span class="n">_bcz_eof</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="Writer.close"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Writer.close">[docs]</a>    <span
        class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Flush data, write 28 bytes BGZF EOF marker, and close BGZF file.</span>

<span class="sd">		samtools will look for a magic EOF marker, just a 28 byte empty BGZF</span>
<span class="sd">		block, and if it is missing warns the BAM file may be truncated. In</span>
<span class="sd">		addition to samtools writing this block, so too does bgzip - so this</span>
<span class="sd">		implementation does too.</span>
<span class="sd">		&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span
            class="n">_buffer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chunk_finished</span><span
            class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_total_size_eof_close</span><span
            class="p">()</span></div>

<div class="viewcode-block" id="Writer.tell"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Writer.tell">[docs]</a>    <span
        class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span
            class="sd">&quot;&quot;&quot;Return a BGZF 64-bit virtual offset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">make_virtual_offset</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="o">.</span><span
            class="n">tell</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span
            class="bp">self</span><span class="o">.</span><span class="n">_buffer</span><span class="p">))</span></div>

<div class="viewcode-block" id="Writer.seekable"><a class="viewcode-back"
                                                    href="../../czip.cz.html#czip.cz.Writer.seekable">[docs]</a>    <span
        class="k">def</span> <span class="nf">seekable</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Writer.isatty"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Writer.isatty">[docs]</a>    <span
        class="k">def</span> <span class="nf">isatty</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return True if connected to a TTY device.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Writer.fileno"><a class="viewcode-back" href="../../czip.cz.html#czip.cz.Writer.fileno">[docs]</a>    <span
        class="k">def</span> <span class="nf">fileno</span><span class="p">(</span><span class="bp">self</span><span
        class="p">):</span>
<span class="w">        </span><span
            class="sd">&quot;&quot;&quot;Return integer file descriptor.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span
            class="o">.</span><span class="n">fileno</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span
            class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Open a file operable with WITH statement.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span
            class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span
            class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="w">        </span><span
            class="sd">&quot;&quot;&quot;Close a file with WITH statement.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
<span class="c1"># ==========================================================</span>
<div class="viewcode-block" id="test_difference"><a class="viewcode-back"
                                                    href="../../czip.cz.html#czip.cz.test_difference">[docs]</a><span
        class="k">def</span> <span class="nf">test_difference</span><span class="p">(</span><span class="n">file1</span><span
        class="p">,</span> <span class="n">file2</span><span class="p">,</span> <span class="n">usecols1</span><span
        class="p">,</span> <span class="n">usecols2</span><span class="p">,</span> <span class="n">sep</span><span
        class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span
        class="p">,</span> <span class="n">header1</span><span class="o">=</span><span class="kc">None</span><span
        class="p">,</span>
                    <span class="n">header2</span><span class="o">=</span><span class="kc">None</span><span
            class="p">,</span> <span class="n">intersect</span><span class="o">=</span><span
            class="kc">False</span><span class="p">,</span> <span class="n">index_cols</span><span
            class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span
            class="mi">1</span><span class="p">]):</span>
    <span class="n">df1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span
            class="n">read_csv</span><span class="p">(</span><span class="n">file1</span><span class="p">,</span> <span
            class="n">usecols</span><span class="o">=</span><span class="n">usecols1</span><span
            class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span
            class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header1</span><span
            class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span
            class="n">read_csv</span><span class="p">(</span><span class="n">file2</span><span class="p">,</span> <span
            class="n">usecols</span><span class="o">=</span><span class="n">usecols2</span><span
            class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">sep</span><span
            class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header2</span><span
            class="p">)</span>
    <span class="n">df1</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span
            class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span
            class="n">df1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span
            class="mi">1</span><span class="p">]))</span>
    <span class="n">df2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span
            class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span
            class="n">df2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span
            class="mi">1</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">intersect</span><span class="p">:</span>
        <span class="n">df1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span
            class="n">index_cols</span><span class="p">,</span> <span class="n">inplace</span><span
            class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span
            class="n">index_cols</span><span class="p">,</span> <span class="n">inplace</span><span
            class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">common_index</span> <span class="o">=</span> <span class="nb">list</span><span
            class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df1</span><span
            class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span
            class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span
            class="n">tolist</span><span class="p">()))</span>
        <span class="n">df1</span> <span class="o">=</span> <span class="n">df1</span><span class="o">.</span><span
            class="n">loc</span><span class="p">[</span><span class="n">common_index</span><span class="p">]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span
            class="n">loc</span><span class="p">[</span><span class="n">common_index</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df1</span><span class="o">.</span><span class="n">sort_values</span><span
            class="p">(</span><span class="n">usecols1</span><span class="p">,</span> <span
            class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df2</span><span class="o">.</span><span class="n">sort_values</span><span
            class="p">(</span><span class="n">usecols2</span><span class="p">,</span> <span
            class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span
            class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span
            class="p">(</span><span class="n">usecols1</span><span class="p">),</span> <span class="nb">len</span><span
            class="p">(</span><span class="n">usecols2</span><span class="p">))):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df1</span><span class="o">.</span><span
            class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span
            class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">==</span> <span
            class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span
            class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span
            class="p">())</span></div>

<span class="c1"># ==========================================================</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span
                                class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fire</span>
    <span class="n">fire</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span
                                class="n">Display</span> <span class="o">=</span> <span class="k">lambda</span> <span
                                class="n">lines</span><span class="p">,</span> <span class="n">out</span><span
                                class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span
                                class="n">lines</span><span class="p">,</span> <span class="n">file</span><span
                                class="o">=</span><span class="n">out</span><span class="p">)</span>
    <span class="n">fire</span><span class="o">.</span><span class="n">Fire</span><span class="p">()</span>
</pre>
                        </div>

                    </div>
                </div>
                <footer>

                    <hr/>

                    <div role="contentinfo">
                        <p>&#169; Copyright 2023, Wubin Ding.</p>
                    </div>

                    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
                    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
                    provided by <a href="https://readthedocs.org">Read the Docs</a>.


                </footer>
            </div>
        </div>
    </section>
</div>
<script>
    jQuery(function () {
        SphinxRtdTheme.Navigation.enable(true);
    });
</script>
<!-- Theme Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-F0T1MBS19V"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-F0T1MBS19V', {
        'anonymize_ip': false,
    });
</script>

</body>
</html>